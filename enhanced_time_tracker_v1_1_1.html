<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Time Tracker - Pay Period Edition</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234facfe'><circle cx='12' cy='12' r='10' stroke='%23667eea' stroke-width='2' fill='%234facfe'/><path d='M12 6v6l4 2' stroke='white' stroke-width='2' stroke-linecap='round'/></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 25px 35px;
            color: white;
        }

        .logo-section {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 20px;
        }

        .logo-text {
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 2px;
            background: linear-gradient(45deg, #ffffff, #e3f2fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .logo-tagline {
            font-size: 0.85rem;
            opacity: 0.8;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 20px;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-controls {
            display: grid;
            grid-template-columns: 1fr 100px 160px 1fr 1fr; /* Made Daily Target narrower - was 150px, now 100px */
            gap: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255,255,255,0.95);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background: white;
        }

        .pay-period-section {
            background: rgba(46, 204, 113, 0.1);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #2ecc71;
            margin-top: 15px;
            backdrop-filter: blur(10px);
        }

        .pay-period-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
            font-size: 13px;
        }

        .pay-period-detail {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pay-period-detail .label {
            font-weight: bold;
            color: #27ae60;
            display: block;
            margin-bottom: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pay-period-detail .value {
            color: #2c3e50;
            font-weight: 600;
        }

        .config-status {
            margin-top: 12px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 35px;
        }

        .timer-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .timer-display {
            font-size: 4rem;
            font-weight: 300;
            margin-bottom: 25px;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            letter-spacing: 2px;
        }

        .timer-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3);
            min-width: 140px;
            min-height: 60px;
        }

        .timer-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(231, 76, 60, 0.4);
        }

        .timer-button.stop {
            background: #c0392b;
        }

        .timer-button.start {
            background: #27ae60;
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }

        .timer-button.start:hover {
            background: #2ecc71;
            box-shadow: 0 12px 25px rgba(39, 174, 96, 0.4);
        }

        .daily-counter {
            margin: 25px 0;
            padding: 20px;
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            backdrop-filter: blur(15px);
        }

        .daily-label {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .daily-progress {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .progress-bar-small {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-small {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .category-selector {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .category-selector label {
            color: rgba(255,255,255,0.9);
            font-weight: 500;
        }

        .category-selector select, .category-selector input {
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255,255,255,0.9);
            color: #333;
            min-width: 120px;
        }

        .stats-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 40px;
            border-radius: 20px;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            backdrop-filter: blur(15px);
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .content-section {
            grid-column: 1 / -1;
            margin-top: 30px;
        }

        .section-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 25px;
            gap: 8px;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .entries-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background: #fafafa;
        }

        .entry-item {
            display: grid;
            grid-template-columns: 100px 1fr 120px 100px 80px 100px;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            align-items: center;
            background: white;
            margin-bottom: 2px;
            transition: all 0.3s ease;
        }

        .entry-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .entry-item:last-child {
            border-bottom: none;
        }

        .entry-date {
            font-weight: 600;
            color: #2c3e50;
        }

        .entry-category {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-work { background: #3498db; color: white; }
        .category-overhead { background: #9b59b6; color: white; }
        .category-travel { background: #2ecc71; color: white; }
        .category-pto { background: #f39c12; color: white; }
        .category-sick { background: #e74c3c; color: white; }
        .category-holiday { background: #27ae60; color: white; }
        .category-bereavement { background: #8e44ad; color: white; }
        .category-jury { background: #16a085; color: white; }

        .entry-project {
            color: #7f8c8d;
            font-style: italic;
        }

        .entry-duration {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .entry-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .edit-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .summary-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background: #fafafa;
        }

        .summary-entry {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: white;
            margin-bottom: 2px;
            transition: all 0.3s ease;
        }

        .summary-entry:hover {
            background: #f8f9fa;
        }

        .summary-entry:last-child {
            border-bottom: none;
        }

        .summary-date {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            margin-bottom: 10px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .summary-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .summary-category {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-total {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            background: #ecf0f1;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
        }

        .export-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 25px;
        }

        .export-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .export-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .export-csv {
            background: #27ae60;
            color: white;
        }

        .export-csv:hover {
            background: #2ecc71;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .clear-btn {
            background: #e74c3c;
            color: white;
        }

        .clear-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        /* Session Recovery Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            color: #e74c3c;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .modal-header .icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .modal-body {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #555;
        }

        .session-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .session-details strong {
            color: #2c3e50;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .timer-display {
                font-size: 3rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .entry-item {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }

            .export-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-content {
                margin: 5% auto;
                width: 95%;
                padding: 20px;
            }

            .modal-actions {
                flex-direction: column;
            }
        }

        .warning-text {
            color: #e74c3c;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .performance-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-section">
                <div>
                    <div class="logo-text">NAKUPUNA</div>
                    <div class="logo-tagline">CONSULTING</div>
                </div>
            </div>
            <h1>üïê Enhanced Time Tracker</h1>
            <div class="header-controls">
                <div class="form-group">
                    <label>Employee Name:</label>
                    <input type="text" id="employeeName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Daily Target Hours:</label>
                    <input type="number" id="dailyTarget" value="8" min="1" max="24" step="0.5">
                </div>
                <div class="form-group">
                    <label>Pay Period:</label>
                    <select id="payPeriodSelect" onchange="onPayPeriodChange()">
                        <option value="">-- Loading... --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Period Start:</label>
                    <input type="date" id="periodStart" onchange="onCustomDateChange()">
                </div>
                <div class="form-group">
                    <label>Period End:</label>
                    <input type="date" id="periodEnd" onchange="onCustomDateChange()">
                </div>
            </div>
            
            <div class="pay-period-section" id="payPeriodInfo" style="display: none;">
                <div class="pay-period-info" id="payPeriodDetails">
                    <!-- Pay period details will be populated here -->
                </div>
                <div class="config-status" id="configStatus">
                    üîÑ Loading pay period configuration...
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="timer-section">
                <div class="timer-display" id="timerDisplay">00:00:00</div>
                <button class="timer-button start" id="timerButton" onclick="toggleTimer()">Start</button>
                
                <div class="daily-counter">
                    <div class="daily-label">Today's Progress</div>
                    <div class="daily-progress" id="dailyCounter">0.0 / 8.0h</div>
                    <div class="progress-bar-small">
                        <div class="progress-fill-small" id="progressFillSmall"></div>
                    </div>
                </div>

                <div class="category-selector">
                    <label>Category:</label>
                    <select id="categorySelect">
                        <option value="work">Work</option>
                        <option value="overhead">Overhead</option>
                        <option value="travel">Travel</option>
                        <option value="pto">PTO</option>
                        <option value="sick">Sick</option>
                        <option value="holiday">Holiday</option>
                        <option value="bereavement">Bereavement</option>
                        <option value="jury">Jury Duty</option>
                    </select>
                    <input type="text" id="projectInput" placeholder="Project (optional)" style="margin-left: 10px;">
                </div>
            </div>

            <div class="stats-section">
                <h3 style="margin-bottom: 20px; font-weight: 300;">Period Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Period Hours</div>
                        <div class="stat-value" id="periodHours">0.0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Days Worked</div>
                        <div class="stat-value" id="daysWorked">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg Daily</div>
                        <div class="stat-value" id="avgDaily">0.0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Target Progress</div>
                        <div class="stat-value" id="targetProgress">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-section">
            <div class="section-tabs">
                <button class="tab-button active" onclick="showTab('detailed')">Detailed View</button>
                <button class="tab-button" onclick="showTab('summary')">Daily Summary</button>
            </div>

            <div id="detailed-tab" class="tab-content active">
                <div class="entries-list" id="entriesList">
                    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                        No time entries yet. Start the timer to begin tracking!
                    </div>
                </div>
            </div>

            <div id="summary-tab" class="tab-content">
                <div class="summary-list" id="summaryList">
                    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                        No time entries yet. Start the timer to begin tracking!
                    </div>
                </div>
            </div>

            <div class="export-section">
                <div class="export-controls">
                    <button class="export-btn export-csv" onclick="exportToCSV()">üìä Export CSV</button>
                    <button class="export-btn clear-btn" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                    <span style="color: #7f8c8d; font-size: 0.9rem;">
                        Data is stored locally in your browser
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Recovery Modal -->
    <div id="sessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="icon">‚ö†Ô∏è</span>
                Incomplete Session Detected
            </div>
            <div class="modal-body">
                <p>It looks like you had a timer running when the browser was closed or the page was refreshed.</p>
                <div class="session-details" id="sessionDetails">
                    <!-- Session details will be populated here -->
                </div>
                <p>How would you like to handle this incomplete session?</p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-primary" onclick="saveSessionAsIs()">Save As-Is</button>
                <button class="modal-btn btn-warning" onclick="adjustSessionTime()">Adjust Time</button>
                <button class="modal-btn btn-danger" onclick="discardSession()">Discard</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let timeEntries = [];
        let timerRunning = false;
        let startTime = null;
        let timerInterval = null;
        let dailyTarget = 8;
        let payPeriodsConfig = null;
        let selectedPayPeriod = null;
        let companyHolidays = [];

        // Pay Period Configuration - Loaded from external JSON file

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Enhanced Time Tracker...');
            
            loadExternalConfig();
            loadData();
            loadSettings();
            updateDisplay();
            setupEventListeners();
            checkForIncompleteSession();
            
            console.log('Enhanced Time Tracker initialization complete');
        });

        function setupEventListeners() {
            document.getElementById('employeeName').addEventListener('input', saveSettings);
            document.getElementById('dailyTarget').addEventListener('change', function() {
                dailyTarget = parseFloat(this.value);
                saveSettings();
                updateDisplay();
            });
        }

        // Session Recovery Functions
        function checkForIncompleteSession() {
            const sessionData = localStorage.getItem('activeTimerSession');
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    const now = new Date();
                    const sessionStart = new Date(session.startTime);
                    const timeDiff = (now - sessionStart) / (1000 * 60 * 60); // hours
                    
                    // Only show recovery if session is within 24 hours and reasonable
                    if (timeDiff > 0 && timeDiff < 24) {
                        showSessionRecoveryModal(session, timeDiff);
                    } else {
                        // Clean up old session data
                        localStorage.removeItem('activeTimerSession');
                    }
                } catch (error) {
                    console.error('Error parsing session data:', error);
                    localStorage.removeItem('activeTimerSession');
                }
            }
        }

        function showSessionRecoveryModal(session, estimatedHours) {
            const modal = document.getElementById('sessionModal');
            const details = document.getElementById('sessionDetails');
            
            const sessionStartTime = new Date(session.startTime);
            const estimatedEndTime = new Date();
            
            details.innerHTML = `
                <strong>Category:</strong> ${session.category}<br>
                <strong>Project:</strong> ${session.project || 'No Project'}<br>
                <strong>Start Time:</strong> ${sessionStartTime.toLocaleString()}<br>
                <strong>Estimated Duration:</strong> ${estimatedHours.toFixed(1)} hours<br>
                <strong>Estimated End Time:</strong> ${estimatedEndTime.toLocaleString()}
            `;
            
            modal.style.display = 'block';
            
            // Store session data for recovery actions
            window.incompleteSession = {
                ...session,
                estimatedHours: estimatedHours,
                estimatedEndTime: estimatedEndTime.toISOString()
            };
        }

        function saveSessionAsIs() {
            const session = window.incompleteSession;
            if (!session) return;
            
            // Create time entry with estimated duration
            const entry = {
                id: Date.now(),
                employee: document.getElementById('employeeName').value || 'Unknown',
                date: session.startTime.split('T')[0],
                category: session.category,
                project: session.project || 'No Project',
                startTime: new Date(session.startTime).toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit'}),
                endTime: new Date(session.estimatedEndTime).toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit'}),
                duration: parseFloat(session.estimatedHours.toFixed(2))
            };
            
            timeEntries.push(entry);
            saveData();
            updateDisplay();
            closeSessionModal();
        }

        function adjustSessionTime() {
            const session = window.incompleteSession;
            if (!session) return;
            
            const actualEndTime = prompt(
                `Please enter the actual end time for this session.\n\n` +
                `Session started: ${new Date(session.startTime).toLocaleString()}\n` +
                `Estimated end: ${new Date(session.estimatedEndTime).toLocaleString()}\n\n` +
                `Enter end time (HH:MM format):`,
                new Date(session.estimatedEndTime).toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit'})
            );
            
            if (actualEndTime && actualEndTime.match(/^\d{2}:\d{2}$/)) {
                const startDate = new Date(session.startTime);
                const [hours, minutes] = actualEndTime.split(':').map(Number);
                const endDate = new Date(startDate);
                endDate.setHours(hours, minutes, 0, 0);
                
                // Handle case where end time is next day
                if (endDate < startDate) {
                    endDate.setDate(endDate.getDate() + 1);
                }
                
                const duration = (endDate - startDate) / (1000 * 60 * 60);
                
                if (duration > 0 && duration <= 24) {
                    const entry = {
                        id: Date.now(),
                        employee: document.getElementById('employeeName').value || 'Unknown',
                        date: startDate.toISOString().split('T')[0],
                        category: session.category,
                        project: session.project || 'No Project',
                        startTime: startDate.toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit'}),
                        endTime: actualEndTime,
                        duration: parseFloat(duration.toFixed(2))
                    };
                    
                    timeEntries.push(entry);
                    saveData();
                    updateDisplay();
                    closeSessionModal();
                } else {
                    alert('Invalid duration. Please check the end time.');
                }
            } else {
                alert('Invalid time format. Please use HH:MM format (e.g., 17:30).');
            }
        }

        function discardSession() {
            if (confirm('Are you sure you want to discard this session? This action cannot be undone.')) {
                closeSessionModal();
            }
        }

        function closeSessionModal() {
            document.getElementById('sessionModal').style.display = 'none';
            localStorage.removeItem('activeTimerSession');
            window.incompleteSession = null;
        }

        // Timer Functions
        function saveActiveSession() {
            if (timerRunning && startTime) {
                const sessionData = {
                    startTime: startTime.toISOString(),
                    category: document.getElementById('categorySelect').value,
                    project: document.getElementById('projectInput').value
                };
                localStorage.setItem('activeTimerSession', JSON.stringify(sessionData));
            }
        }

        function clearActiveSession() {
            localStorage.removeItem('activeTimerSession');
        }

        function toggleTimer() {
            if (!timerRunning) {
                startTimer();
            } else {
                stopTimer();
            }
        }

        function startTimer() {
            const employeeName = document.getElementById('employeeName').value.trim();
            if (!employeeName) {
                alert('Please enter your employee name first.');
                document.getElementById('employeeName').focus();
                return;
            }

            startTime = new Date();
            timerRunning = true;
            
            const button = document.getElementById('timerButton');
            button.textContent = 'Stop';
            button.className = 'timer-button stop';
            
            timerInterval = setInterval(updateTimer, 1000);
            
            // Save active session for recovery
            saveActiveSession();
            
            console.log('Timer started at:', startTime);
        }

        function stopTimer() {
            if (!timerRunning || !startTime) return;
            
            const endTime = new Date();
            const duration = (endTime - startTime) / (1000 * 60 * 60); // Convert to hours
            
            const entry = {
                id: Date.now(),
                employee: document.getElementById('employeeName').value,
                date: startTime.toISOString().split('T')[0],
                category: document.getElementById('categorySelect').value,
                project: document.getElementById('projectInput').value || 'No Project',
                startTime: startTime.toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit'}),
                endTime: endTime.toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit'}),
                duration: parseFloat(duration.toFixed(2))
            };
            
            timeEntries.push(entry);
            saveData();
            
            // Reset timer
            timerRunning = false;
            startTime = null;
            clearInterval(timerInterval);
            clearActiveSession(); // Clear session recovery data
            
            const button = document.getElementById('timerButton');
            button.textContent = 'Start';
            button.className = 'timer-button start';
            
            document.getElementById('timerDisplay').textContent = '00:00:00';
            
            updateDisplay();
            console.log('Timer stopped, entry saved:', entry);
        }

        function updateTimer() {
            if (!timerRunning || !startTime) return;
            
            const now = new Date();
            const elapsed = now - startTime;
            
            const hours = Math.floor(elapsed / (1000 * 60 * 60));
            const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
            
            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
            
            // Update daily counter in real-time
            updateDailyCounter();
            
            // Save session periodically
            if (seconds % 30 === 0) { // Every 30 seconds
                saveActiveSession();
            }
        }

        // Pay Period Configuration Management
        function loadBuiltinConfig() {
            try {
                payPeriodsConfig = BUILTIN_CONFIG;
                
                if (payPeriodsConfig.holidays) {
                    companyHolidays = payPeriodsConfig.holidays;
                }
                
                populatePayPeriodDropdown();
                selectCurrentPayPeriod();
                
                console.log('Built-in configuration loaded successfully');
                
            } catch (error) {
                console.error('Failed to load built-in config:', error);
                enableManualDateSelection();
            }
        }

        function populatePayPeriodDropdown() {
            const select = document.getElementById('payPeriodSelect');
            select.innerHTML = '<option value="">-- Select Pay Period --</option>';
            
            if (!payPeriodsConfig || !payPeriodsConfig.payPeriods) return;
            
            payPeriodsConfig.payPeriods.forEach((period, index) => {
                const option = document.createElement('option');
                option.value = period.id;
                
                // Handle both formats: periodStart/periodEnd (PowerShell scripts) and startDate/endDate (legacy)
                const startDate = period.periodStart || period.startDate;
                const endDate = period.periodEnd || period.endDate;
                
                if (period.description) {
                    option.textContent = period.description;
                } else {
                    option.textContent = `${period.id} (${startDate} to ${endDate})`;
                }
                
                select.appendChild(option);
            });
        }

        function selectCurrentPayPeriod() {
            if (!payPeriodsConfig || !payPeriodsConfig.payPeriods) return;
            
            const savedSelection = localStorage.getItem('selectedPayPeriod');
            if (savedSelection) {
                const period = payPeriodsConfig.payPeriods.find(p => p.id === savedSelection);
                if (period) {
                    setPayPeriod(period);
                    return;
                }
            }
            
            const today = new Date().toISOString().split('T')[0];
            const currentPeriod = payPeriodsConfig.payPeriods.find(period => {
                // Handle both formats: periodStart/periodEnd (PowerShell scripts) and startDate/endDate (legacy)
                const startDate = period.periodStart || period.startDate;
                const endDate = period.periodEnd || period.endDate;
                return today >= startDate && today <= endDate;
            });
            
            if (currentPeriod) {
                setPayPeriod(currentPeriod);
            } else {
                const upcomingPeriod = payPeriodsConfig.payPeriods.find(period => {
                    const startDate = period.periodStart || period.startDate;
                    return today < startDate;
                });
                
                if (upcomingPeriod) {
                    setPayPeriod(upcomingPeriod);
                }
            }
        }

        function setPayPeriod(period) {
            selectedPayPeriod = period;
            document.getElementById('payPeriodSelect').value = period.id;
            
            // Handle both formats: periodStart/periodEnd (PowerShell scripts) and startDate/endDate (legacy)
            const startDate = period.periodStart || period.startDate;
            const endDate = period.periodEnd || period.endDate;
            
            document.getElementById('periodStart').value = startDate;
            document.getElementById('periodEnd').value = endDate;
            
            updatePayPeriodInfo();
            updateDisplay();
            
            localStorage.setItem('selectedPayPeriod', period.id);
        }

        function onPayPeriodChange() {
            const select = document.getElementById('payPeriodSelect');
            const periodId = select.value;
            
            if (!periodId) {
                selectedPayPeriod = null;
                document.getElementById('payPeriodInfo').style.display = 'none';
                return;
            }
            
            const period = payPeriodsConfig.payPeriods.find(p => p.id === periodId);
            if (period) {
                setPayPeriod(period);
            }
        }

        function onCustomDateChange() {
            document.getElementById('payPeriodSelect').value = '';
            selectedPayPeriod = null;
            localStorage.removeItem('selectedPayPeriod');
            document.getElementById('payPeriodInfo').style.display = 'none';
            updateDisplay();
        }

        function updatePayPeriodInfo() {
            if (!selectedPayPeriod) {
                document.getElementById('payPeriodInfo').style.display = 'none';
                return;
            }

            // Handle both formats: periodStart/periodEnd (PowerShell scripts) and startDate/endDate (legacy)
            const startDate = new Date(selectedPayPeriod.periodStart || selectedPayPeriod.startDate);
            const endDate = new Date(selectedPayPeriod.periodEnd || selectedPayPeriod.endDate);
            const today = new Date();
            
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const workingDays = calculateWorkingDays(startDate, endDate);
            const elapsedDays = Math.max(0, Math.ceil((today - startDate) / (1000 * 60 * 60 * 24)));
            const remainingDays = Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));
            
            const periodStartStr = selectedPayPeriod.periodStart || selectedPayPeriod.startDate;
            const periodEndStr = selectedPayPeriod.periodEnd || selectedPayPeriod.endDate;
            const holidaysInPeriod = getHolidaysInPeriod(periodStartStr, periodEndStr);
            
            const details = document.getElementById('payPeriodDetails');
            let detailsHTML = `
                <div class="pay-period-detail">
                    <span class="label">Period</span>
                    <span class="value">${selectedPayPeriod.id}</span>
                </div>
                <div class="pay-period-detail">
                    <span class="label">Total Days</span>
                    <span class="value">${totalDays}</span>
                </div>
                <div class="pay-period-detail">
                    <span class="label">Working Days</span>
                    <span class="value">${workingDays}</span>
                </div>
                <div class="pay-period-detail">
                    <span class="label">Days Elapsed</span>
                    <span class="value">${elapsedDays}</span>
                </div>
                <div class="pay-period-detail">
                    <span class="label">Days Remaining</span>
                    <span class="value">${remainingDays}</span>
                </div>`;

            // Show PowerShell-generated fields if available
            if (selectedPayPeriod.timesheetDue) {
                detailsHTML += `
                <div class="pay-period-detail">
                    <span class="label">Timesheet Due</span>
                    <span class="value">${selectedPayPeriod.timesheetDue}</span>
                </div>`;
            }

            if (selectedPayPeriod.payDay) {
                detailsHTML += `
                <div class="pay-period-detail">
                    <span class="label">Pay Day</span>
                    <span class="value">${selectedPayPeriod.payDay}</span>
                </div>`;
            }
            
            if (holidaysInPeriod.length > 0) {
                detailsHTML += `
                <div class="pay-period-detail">
                    <span class="label">Holidays</span>
                    <span class="value">${holidaysInPeriod.length}</span>
                </div>`;
            }
            
            details.innerHTML = detailsHTML;
            
            if (holidaysInPeriod.length > 0) {
                const holidayNames = holidaysInPeriod.map(h => h.name).join(', ');
                details.innerHTML += `
                    <div class="pay-period-detail" style="grid-column: 1 / -1;">
                        <span class="label">Holiday Details</span>
                        <span class="value" style="font-size: 0.8em;">${holidayNames}</span>
                    </div>
                `;
            }
            
            document.getElementById('payPeriodInfo').style.display = 'block';
        }

        function calculateWorkingDays(startDate, endDate) {
            let workingDays = 0;
            const current = new Date(startDate);
            
            while (current <= endDate) {
                const dayOfWeek = current.getDay();
                const dateStr = current.toISOString().split('T')[0];
                
                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !isHoliday(dateStr)) {
                    workingDays++;
                }
                
                current.setDate(current.getDate() + 1);
            }
            
            return workingDays;
        }

        function isHoliday(dateStr) {
            return companyHolidays.some(holiday => holiday.date === dateStr);
        }

        function getHolidaysInPeriod(startDate, endDate) {
            return companyHolidays.filter(holiday => 
                holiday.date >= startDate && holiday.date <= endDate
            );
        }

        function enableManualDateSelection() {
            const today = new Date();
            const twoWeeksAgo = new Date(today.getTime() - (14 * 24 * 60 * 60 * 1000));
            
            document.getElementById('periodStart').value = twoWeeksAgo.toISOString().split('T')[0];
            document.getElementById('periodEnd').value = today.toISOString().split('T')[0];
            
            document.getElementById('payPeriodSelect').innerHTML = '<option value="">Manual Date Selection</option>';
            document.getElementById('configStatus').textContent = '‚ö†Ô∏è Using manual date selection - pay period config not available';
            document.getElementById('configStatus').style.backgroundColor = '#fff3cd';
            document.getElementById('configStatus').style.color = '#856404';
            document.getElementById('configStatus').style.borderColor = '#ffeaa7';
        }

        // Data Management
        function saveData() {
            localStorage.setItem('timeTrackerData', JSON.stringify(timeEntries));
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('timeTrackerData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed)) {
                        timeEntries = parsed;
                    } else {
                        console.warn('Invalid time entries data in localStorage, resetting to empty array');
                        timeEntries = [];
                        localStorage.removeItem('timeTrackerData');
                    }
                } else {
                    timeEntries = [];
                }
            } catch (error) {
                console.error('Error loading time entries data:', error);
                console.warn('Corrupted data detected, resetting to empty array');
                timeEntries = [];
                localStorage.removeItem('timeTrackerData');
            }
        }

        function saveSettings() {
            const settings = {
                employeeName: document.getElementById('employeeName').value,
                dailyTarget: document.getElementById('dailyTarget').value
            };
            localStorage.setItem('timeTrackerSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('timeTrackerSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('employeeName').value = settings.employeeName || '';
                document.getElementById('dailyTarget').value = settings.dailyTarget || 8;
                dailyTarget = parseFloat(settings.dailyTarget || 8);
            }
        }

        // Display Updates
        function updateDisplay() {
            updateStats();
            updateDailyCounter();
            updateEntriesList();
            updateSummaryList();
            updatePayPeriodInfo();
        }

        function updateStats() {
            const filteredEntries = getFilteredEntries();
            const totalHours = filteredEntries.reduce((sum, entry) => sum + entry.duration, 0);
            const workDays = new Set(filteredEntries.map(entry => entry.date)).size;
            const avgDaily = workDays > 0 ? totalHours / workDays : 0;
            
            // Calculate target progress
            const startDate = new Date(document.getElementById('periodStart').value);
            const endDate = new Date(document.getElementById('periodEnd').value);
            const targetDays = calculateWorkingDays(startDate, endDate);
            const targetHours = targetDays * dailyTarget;
            const progress = targetHours > 0 ? (totalHours / targetHours) * 100 : 0;
            
            document.getElementById('periodHours').textContent = totalHours.toFixed(1);
            document.getElementById('daysWorked').textContent = workDays;
            document.getElementById('avgDaily').textContent = avgDaily.toFixed(1);
            document.getElementById('targetProgress').textContent = Math.round(progress) + '%';
        }

        function updateDailyCounter() {
            const today = new Date().toISOString().split('T')[0];
            const todayEntries = timeEntries.filter(entry => entry.date === today);
            let dailyHours = todayEntries.reduce((sum, entry) => sum + entry.duration, 0);
            
            // Add current session time if timer is running
            if (timerRunning && startTime) {
                const elapsed = (new Date() - startTime) / (1000 * 60 * 60);
                dailyHours += elapsed;
            }
            
            const progress = Math.min((dailyHours / dailyTarget) * 100, 100);
            
            document.getElementById('dailyCounter').textContent = `${dailyHours.toFixed(1)} / ${dailyTarget}h`;
            document.getElementById('progressFillSmall').style.width = progress + '%';
        }

        function getFilteredEntries() {
            const startDate = document.getElementById('periodStart').value;
            const endDate = document.getElementById('periodEnd').value;
            
            return timeEntries.filter(entry => {
                return entry.date >= startDate && entry.date <= endDate;
            });
        }

        function updateEntriesList() {
            const filteredEntries = getFilteredEntries();
            const container = document.getElementById('entriesList');
            
            if (filteredEntries.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;">No time entries for selected period.</div>';
                return;
            }
            
            // Performance warning
            if (filteredEntries.length > 100) {
                container.innerHTML = '<div class="performance-warning">‚ö†Ô∏è Large dataset detected (' + filteredEntries.length + ' entries). Performance may be affected. Consider exporting and clearing old data.</div>';
            }
            
            // Sort by date and start time (newest first)
            const sortedEntries = filteredEntries.sort((a, b) => {
                const dateCompare = b.date.localeCompare(a.date);
                if (dateCompare !== 0) return dateCompare;
                return b.startTime.localeCompare(a.startTime);
            });
            
            const entriesHTML = sortedEntries.map(entry => `
                <div class="entry-item">
                    <div class="entry-date">${entry.date}</div>
                    <div class="entry-category category-${entry.category}">${entry.category.toUpperCase()}</div>
                    <div class="entry-project">${entry.project}</div>
                    <div>${entry.startTime} - ${entry.endTime}</div>
                    <div class="entry-duration">${entry.duration}h</div>
                    <div class="entry-actions">
                        <button class="action-btn edit-btn" onclick="editEntry(${entry.id})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteEntry(${entry.id})">Delete</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = entriesHTML;
        }

        function updateSummaryList() {
            const filteredEntries = getFilteredEntries();
            const container = document.getElementById('summaryList');
            
            if (filteredEntries.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;">No time entries for selected period.</div>';
                return;
            }
            
            // Group by date
            const groupedByDate = {};
            filteredEntries.forEach(entry => {
                if (!groupedByDate[entry.date]) {
                    groupedByDate[entry.date] = {};
                }
                if (!groupedByDate[entry.date][entry.category]) {
                    groupedByDate[entry.date][entry.category] = 0;
                }
                groupedByDate[entry.date][entry.category] += entry.duration;
            });
            
            // Sort dates (newest first)
            const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.localeCompare(a));
            
            const summaryHTML = sortedDates.map(date => {
                const categories = groupedByDate[date];
                const totalHours = Object.values(categories).reduce((sum, hours) => sum + hours, 0);
                
                const categoryTags = Object.entries(categories).map(([category, hours]) => 
                    `<span class="summary-category category-${category}">${category}: ${hours.toFixed(1)}h</span>`
                ).join('');
                
                return `
                    <div class="summary-entry">
                        <div class="summary-date">${date}</div>
                        <div class="summary-breakdown">${categoryTags}</div>
                        <div class="summary-total">${totalHours.toFixed(1)}h</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = summaryHTML;
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Entry Management
        function editEntry(entryId) {
            const entry = timeEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            const newProject = prompt('Edit project name:', entry.project);
            if (newProject !== null) {
                entry.project = newProject || 'No Project';
                saveData();
                updateDisplay();
            }
        }

        function deleteEntry(entryId) {
            if (confirm('Are you sure you want to delete this entry?')) {
                timeEntries = timeEntries.filter(entry => entry.id !== entryId);
                saveData();
                updateDisplay();
            }
        }

        // Export Functions
        function exportToCSV() {
            const filteredEntries = getFilteredEntries();
            if (filteredEntries.length === 0) {
                alert('No data to export for the selected period.');
                return;
            }
            
            // CSV Headers
            let csv = 'Employee Name,Date,Category,Project,Start Time,End Time,Duration (Hours)\n';
            
            // Add data rows
            filteredEntries.forEach(entry => {
                csv += `"${entry.employee}","${entry.date}","${entry.category}","${entry.project}","${entry.startTime}","${entry.endTime}",${entry.duration}\n`;
            });
            
            // Add summary
            const totalHours = filteredEntries.reduce((sum, entry) => sum + entry.duration, 0);
            const workDays = new Set(filteredEntries.map(entry => entry.date)).size;
            const avgDaily = workDays > 0 ? totalHours / workDays : 0;
            const periodStart = document.getElementById('periodStart').value;
            const periodEnd = document.getElementById('periodEnd').value;
            
            csv += '\nSUMMARY\n';
            csv += `Period,"${periodStart} to ${periodEnd}"\n`;
            csv += `Total Hours,${totalHours.toFixed(2)}\n`;
            csv += `Work Days,${workDays}\n`;
            csv += `Average Daily Hours,${avgDaily.toFixed(2)}\n`;
            csv += `Export Date,"${new Date().toISOString().split('T')[0]}"\n`;
            
            // Pay period information
            if (selectedPayPeriod) {
                csv += `Pay Period,${selectedPayPeriod.id}\n`;
                csv += `Pay Period Description,"${selectedPayPeriod.description}"\n`;
            }
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            const employeeName = document.getElementById('employeeName').value || 'Employee';
            const periodLabel = selectedPayPeriod ? selectedPayPeriod.id : `${periodStart}_to_${periodEnd}`;
            link.download = `${employeeName}_TimeSheet_${periodLabel}.csv`;
            link.href = url;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all time entries? This action cannot be undone.\n\nRecommendation: Export your data first!')) {
                if (confirm('Last chance! Are you absolutely sure you want to delete all time tracking data?')) {
                    timeEntries = [];
                    saveData();
                    updateDisplay();
                    alert('All time entries have been cleared.');
                }
            }
        }

        // Utility Functions
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Prevent data loss on page unload when timer is running
        window.addEventListener('beforeunload', function(e) {
            if (timerRunning) {
                saveActiveSession();
                e.preventDefault();
                e.returnValue = 'You have a timer running. Are you sure you want to leave?';
                return 'You have a timer running. Are you sure you want to leave?';
            }
        });

        // Handle visibility change (when tab becomes hidden/visible)
        document.addEventListener('visibilitychange', function() {
            if (timerRunning) {
                if (document.hidden) {
                    saveActiveSession();
                } else {
                    // Tab became visible again, continue normal operation
                    console.log('Tab visible again, timer still running');
                }
            }
        });
    </script>
</body>
</html>