<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker - Pay Period Edition v1.1.2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .logo-section {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            text-align: right;
        }

        .logo-text {
            font-size: 1.5em;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .logo-tagline {
            font-size: 0.8em;
            opacity: 0.8;
            letter-spacing: 1px;
        }

        .header-controls {
            display: grid;
            grid-template-columns: 1fr 100px 200px 120px 120px;
            gap: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .form-group input,
        .form-group select {
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }

        .form-group input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .pay-period-section {
            background: #e8f5e8;
            margin: 20px;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #27ae60;
        }

        .pay-period-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .pay-period-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pay-period-detail .label {
            font-weight: 600;
            color: #2c3e50;
        }

        .pay-period-detail .value {
            color: #27ae60;
            font-weight: bold;
        }

        .config-status {
            font-size: 0.9em;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
        }

        .config-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .config-status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .config-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .main-content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .timer-section {
            text-align: center;
        }

        .timer-display {
            font-size: 4em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .timer-button {
            padding: 15px 40px;
            font-size: 1.2em;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            margin: 0 10px;
        }

        .timer-button.start {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .timer-button.stop {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .timer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .daily-counter {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .daily-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .daily-progress {
            font-size: 1.5em;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 10px;
        }

        .progress-bar-small {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-small {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }

        .category-selector {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .category-selector label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .category-selector select,
        .category-selector input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stats-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #27ae60;
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .entries-section {
            grid-column: 1 / -1;
            margin-top: 30px;
        }

        .export-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .export-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            background: #27ae60;
            color: white;
        }

        .export-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .view-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .view-button {
            padding: 8px 15px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .view-button.active {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .entries-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }

        .entry-item {
            padding: 15px;
            border-bottom: 1px solid #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entry-item:last-child {
            border-bottom: none;
        }

        .entry-info {
            flex: 1;
        }

        .entry-time {
            font-weight: bold;
            color: #27ae60;
            margin-left: 15px;
        }

        .footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .header-controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .logo-section {
                position: static;
                transform: none;
                text-align: center;
                margin-top: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üïê Time Tracker</h1>
            <div class="logo-section">
                <div>
                    <div class="logo-text">NAKUPUNA</div>
                    <div class="logo-tagline">CONSULTING</div>
                </div>
            </div>
            <div class="header-controls">
                <div class="form-group">
                    <label>Employee Name:</label>
                    <input type="text" id="employeeName" placeholder="Enter your name" onchange="saveSettings()">
                </div>
                <div class="form-group">
                    <label>Daily Target Hours:</label>
                    <input type="number" id="dailyTarget" value="8" min="1" max="24" step="0.5" onchange="updateDisplay()">
                </div>
                <div class="form-group">
                    <label>Pay Period:</label>
                    <select id="payPeriodSelect" onchange="onPayPeriodChange()">
                        <option value="">üîÑ Loading pay periods...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Period Start:</label>
                    <input type="date" id="periodStart" onchange="onCustomDateChange()">
                </div>
                <div class="form-group">
                    <label>Period End:</label>
                    <input type="date" id="periodEnd" onchange="onCustomDateChange()">
                </div>
            </div>
        </div>

        <div class="pay-period-section" id="payPeriodInfo" style="display: none;">
            <h3 style="margin-bottom: 15px; color: #27ae60;">üìÖ Pay Period Information</h3>
            <div class="pay-period-info">
                <div class="pay-period-detail">
                    <span class="label">Period</span>
                    <span class="value" id="periodDisplay">-</span>
                </div>
                <div class="pay-period-detail">
                    <span class="label">Timesheet Due</span>
                    <span class="value" id="timesheetDue">-</span>
                </div>
                <div class="pay-period-detail">
                    <span class="label">Pay Day</span>
                    <span class="value" id="payDay">-</span>
                </div>
                <div class="pay-period-detail">
                    <span class="label">Working Days</span>
                    <span class="value" id="workingDays">-</span>
                </div>
                <div class="pay-period-detail">
                    <span class="label">Days Remaining</span>
                    <span class="value" id="daysRemaining">-</span>
                </div>
            </div>
            <div class="config-status success" id="configStatus">
                ‚úÖ Pay periods configuration loaded successfully!
            </div>
        </div>

        <div class="main-content">
            <div class="timer-section">
                <div class="timer-display" id="timerDisplay">00:00:00</div>
                <button class="timer-button start" id="timerButton" onclick="toggleTimer()">Start</button>
                
                <div class="daily-counter">
                    <div class="daily-label">Today's Progress</div>
                    <div class="daily-progress" id="dailyCounter">0.0 / 8.0h</div>
                    <div class="progress-bar-small">
                        <div class="progress-fill-small" id="progressFillSmall"></div>
                    </div>
                </div>

                <div class="category-selector">
                    <label>Category:</label>
                    <select id="categorySelect">
                        <option value="work">Work</option>
                        <option value="overhead">Overhead</option>
                        <option value="travel">Travel</option>
                        <option value="pto">PTO</option>
                        <option value="sick">Sick</option>
                        <option value="holiday">Holiday</option>
                        <option value="bereavement">Bereavement</option>
                        <option value="jury">Jury Duty</option>
                    </select>
                    <input type="text" id="projectInput" placeholder="Project (optional)" style="margin-top: 10px;">
                </div>
            </div>

            <div class="stats-section">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üìä Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="totalHours">0.0</span>
                        <div class="stat-label">Total Hours</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="workDays">0</span>
                        <div class="stat-label">Work Days</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avgDaily">0.0</span>
                        <div class="stat-label">Avg Daily</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="daysElapsed">0</span>
                        <div class="stat-label">Days in Period</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="entries-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #2c3e50;">üìù Time Entries</h3>
                <div class="export-section">
                    <button class="export-button" onclick="exportToCSV()">üì• Export CSV</button>
                    <button class="export-button" onclick="importCSV()" style="background: #3498db;">üì§ Import CSV</button>
                    <button class="export-button" onclick="clearAllData()" style="background: #e74c3c;">üóëÔ∏è Clear All</button>
                </div>
            </div>
            
            <div class="view-controls">
                <button class="view-button active" onclick="setView('detailed')">Detailed View</button>
                <button class="view-button" onclick="setView('daily')">Daily Summary</button>
            </div>
            
            <div class="entries-list" id="entriesList">
                <div style="padding: 20px; text-align: center; color: #7f8c8d;">
                    No time entries yet. Start the timer to begin tracking!
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        Philippe Addelia | Created: August 17, 2025 PST
    </div>

    <script>
        // NAKUPUNA Pay Periods Configuration - Embedded for GitHub Pages compatibility
        const NAKUPUNA_CONFIG = {
            "payPeriods": [
                {
                    "id": "2025-15",
                    "periodStart": "2025-08-02",
                    "periodEnd": "2025-08-15",
                    "timesheetDue": "2025-08-15",
                    "payDay": "2025-08-22",
                    "description": "Pay Period 15 - Aug 2-15, 2025"
                },
                {
                    "id": "2025-16",
                    "periodStart": "2025-08-16",
                    "periodEnd": "2025-08-29",
                    "timesheetDue": "2025-08-29",
                    "payDay": "2025-09-05",
                    "description": "Pay Period 16 - Aug 16-29, 2025"
                },
                {
                    "id": "2025-17",
                    "periodStart": "2025-08-30",
                    "periodEnd": "2025-09-15",
                    "timesheetDue": "2025-09-15",
                    "payDay": "2025-09-22",
                    "description": "Pay Period 17 - Aug 30 - Sep 15, 2025"
                },
                {
                    "id": "2025-18",
                    "periodStart": "2025-09-16",
                    "periodEnd": "2025-09-30",
                    "timesheetDue": "2025-09-30",
                    "payDay": "2025-10-07",
                    "description": "Pay Period 18 - Sep 16-30, 2025"
                },
                {
                    "id": "2025-19",
                    "periodStart": "2025-10-01",
                    "periodEnd": "2025-10-15",
                    "timesheetDue": "2025-10-15",
                    "payDay": "2025-10-22",
                    "description": "Pay Period 19 - Oct 1-15, 2025"
                },
                {
                    "id": "2025-20",
                    "periodStart": "2025-10-16",
                    "periodEnd": "2025-10-31",
                    "timesheetDue": "2025-10-31",
                    "payDay": "2025-11-07",
                    "description": "Pay Period 20 - Oct 16-31, 2025"
                },
                {
                    "id": "2025-21",
                    "periodStart": "2025-11-01",
                    "periodEnd": "2025-11-14",
                    "timesheetDue": "2025-11-14",
                    "payDay": "2025-11-21",
                    "description": "Pay Period 21 - Nov 1-14, 2025"
                },
                {
                    "id": "2025-22",
                    "periodStart": "2025-11-15",
                    "periodEnd": "2025-11-28",
                    "timesheetDue": "2025-11-28",
                    "payDay": "2025-12-05",
                    "description": "Pay Period 22 - Nov 15-28, 2025"
                },
                {
                    "id": "2025-23",
                    "periodStart": "2025-11-29",
                    "periodEnd": "2025-12-15",
                    "timesheetDue": "2025-12-15",
                    "payDay": "2025-12-22",
                    "description": "Pay Period 23 - Nov 29 - Dec 15, 2025"
                },
                {
                    "id": "2025-24",
                    "periodStart": "2025-12-16",
                    "periodEnd": "2025-12-31",
                    "timesheetDue": "2025-12-31",
                    "payDay": "2026-01-07",
                    "description": "Pay Period 24 - Dec 16-31, 2025"
                }
            ],
            "holidays": [
                {
                    "date": "2025-01-01",
                    "name": "New Year's Day",
                    "type": "federal"
                },
                {
                    "date": "2025-01-20",
                    "name": "Martin Luther King Jr Day",
                    "type": "federal"
                },
                {
                    "date": "2025-02-17",
                    "name": "Washington's Bday/President's Day",
                    "type": "federal"
                },
                {
                    "date": "2025-05-26",
                    "name": "Memorial Day",
                    "type": "federal"
                },
                {
                    "date": "2025-06-19",
                    "name": "Juneteenth",
                    "type": "federal"
                },
                {
                    "date": "2025-07-04",
                    "name": "Independence Day",
                    "type": "federal"
                },
                {
                    "date": "2025-09-01",
                    "name": "Labor Day",
                    "type": "federal"
                },
                {
                    "date": "2025-10-13",
                    "name": "Columbus Day",
                    "type": "federal"
                },
                {
                    "date": "2025-11-11",
                    "name": "Veteran's Day",
                    "type": "federal"
                },
                {
                    "date": "2025-11-27",
                    "name": "Thanksgiving Day",
                    "type": "federal"
                },
                {
                    "date": "2025-12-25",
                    "name": "Christmas Day",
                    "type": "federal"
                }
            ],
            "configVersion": "1.1.2",
            "lastUpdated": "2025-08-17",
            "company": "NAKUPUNA CONSULTING"
        };

        // Global variables
        let timeEntries = [];
        let currentSession = null;
        let timerInterval = null;
        let isRunning = false;
        let dailyTarget = 8;
        let currentView = 'detailed';
        let payPeriodsConfig = null;
        let selectedPayPeriod = null;
        let companyHolidays = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Time tracker initializing...');
            
            loadData();
            loadSettings();
            loadPayPeriodsConfig();
            updateDisplay();
            
            // Check for session recovery after short delay
            setTimeout(recoverSession, 1000);
            
            console.log('Time tracker initialization complete');
        });

        // Pay Period Configuration Management - Hybrid approach with fallback
        async function loadPayPeriodsConfig() {
            console.log('Loading pay periods configuration...');
            
            // Try external JSON first, then fall back to embedded config
            try {
                await loadExternalJSON();
            } catch (error) {
                console.warn('External JSON failed, using embedded config:', error.message);
                loadEmbeddedConfig();
            }
        }

        async function loadExternalJSON() {
            console.log('Attempting to load external pay_periods_config.json...');
            
            const possiblePaths = [
                './pay_periods_config.json',
                'pay_periods_config.json',
                '/pay_periods_config.json'
            ];
            
            for (const path of possiblePaths) {
                try {
                    console.log(`Trying to fetch: ${path}`);
                    const response = await fetch(path);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const config = await response.json();
                    
                    payPeriodsConfig = config;
                    if (config.holidays) {
                        companyHolidays = config.holidays;
                    }
                    
                    populatePayPeriodDropdown();
                    selectCurrentPayPeriod();
                    
                    const status = document.getElementById('configStatus');
                    status.className = 'config-status success';
                    status.textContent = `‚úÖ External JSON config loaded successfully! (${path})`;
                    
                    console.log('External JSON config loaded from:', path);
                    return; // Success - exit function
                    
                } catch (error) {
                    console.warn(`Failed to load from ${path}:`, error.message);
                    continue; // Try next path
                }
            }
            
            throw new Error('All external JSON paths failed');
        }

        function loadEmbeddedConfig() {
            console.log('Loading embedded NAKUPUNA configuration...');
            
            payPeriodsConfig = NAKUPUNA_CONFIG;
            
            console.log('Loaded config:', {
                payPeriods: payPeriodsConfig.payPeriods ? payPeriodsConfig.payPeriods.length : 0,
                firstPeriod: payPeriodsConfig.payPeriods ? payPeriodsConfig.payPeriods[0] : null,
                holidays: payPeriodsConfig.holidays ? payPeriodsConfig.holidays.length : 0
            });
            
            if (NAKUPUNA_CONFIG.holidays) {
                companyHolidays = NAKUPUNA_CONFIG.holidays;
            }
            
            populatePayPeriodDropdown();
            selectCurrentPayPeriod();
            
            const status = document.getElementById('configStatus');
            status.className = 'config-status success';
            status.textContent = '‚úÖ NAKUPUNA pay periods loaded successfully! (Embedded mode)';
            
            console.log('Embedded NAKUPUNA config loaded successfully');
        }

        function populatePayPeriodDropdown() {
            const select = document.getElementById('payPeriodSelect');
            select.innerHTML = '<option value="">-- Select Pay Period --</option>';
            
            if (!payPeriodsConfig || !payPeriodsConfig.payPeriods) {
                console.warn('No pay periods config available');
                return;
            }
            
            console.log('Populating dropdown with', payPeriodsConfig.payPeriods.length, 'periods');
            
            payPeriodsConfig.payPeriods.forEach((period, index) => {
                const option = document.createElement('option');
                option.value = period.id;
                
                // Ensure we have a proper description
                let description = period.description;
                if (!description) {
                    description = `${period.id} (${period.periodStart} to ${period.periodEnd})`;
                }
                
                option.textContent = description;
                option.setAttribute('data-start', period.periodStart);
                option.setAttribute('data-end', period.periodEnd);
                
                select.appendChild(option);
                console.log(`Added option ${index + 1}: ${description}`);
            });
            
            console.log('Dropdown population complete. Total options:', select.options.length);
        }

        function selectCurrentPayPeriod() {
            if (!payPeriodsConfig || !payPeriodsConfig.payPeriods) {
                console.warn('No pay periods config available for auto-selection');
                return;
            }
            
            // Check if we have a saved selection first
            const savedSelection = localStorage.getItem('selectedPayPeriod');
            if (savedSelection) {
                console.log('Found saved selection:', savedSelection);
                const period = payPeriodsConfig.payPeriods.find(p => p.id === savedSelection);
                if (period) {
                    console.log('Restoring saved period:', period.description);
                    setPayPeriod(period);
                    document.getElementById('payPeriodSelect').value = period.id;
                    return;
                }
            }
            
            // Auto-select current pay period based on today's date
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            console.log('Looking for current pay period for date:', todayStr);
            
            for (const period of payPeriodsConfig.payPeriods) {
                const startDate = new Date(period.periodStart);
                const endDate = new Date(period.periodEnd);
                
                console.log(`Checking period ${period.id}: ${period.periodStart} to ${period.periodEnd}`);
                
                if (today >= startDate && today <= endDate) {
                    console.log('Auto-selected current pay period:', period.id, period.description);
                    setPayPeriod(period);
                    document.getElementById('payPeriodSelect').value = period.id;
                    return;
                }
            }
            
            console.log('No current pay period found for today, user must select manually');
            
            // If no current period found, maybe select the most recent or next upcoming period
            const futurePeriods = payPeriodsConfig.payPeriods.filter(p => new Date(p.periodStart) > today);
            if (futurePeriods.length > 0) {
                const nextPeriod = futurePeriods[0];
                console.log('No current period, selecting next period:', nextPeriod.id);
                setPayPeriod(nextPeriod);
                document.getElementById('payPeriodSelect').value = nextPeriod.id;
            }
        }

        function setPayPeriod(period) {
            selectedPayPeriod = period;
            
            document.getElementById('periodStart').value = period.periodStart;
            document.getElementById('periodEnd').value = period.periodEnd;
            
            updatePayPeriodInfo();
            updateDisplay();
            
            localStorage.setItem('selectedPayPeriod', period.id);
        }

        function onPayPeriodChange() {
            const select = document.getElementById('payPeriodSelect');
            const periodId = select.value;
            
            if (!periodId) {
                selectedPayPeriod = null;
                document.getElementById('payPeriodInfo').style.display = 'none';
                return;
            }
            
            const period = payPeriodsConfig.payPeriods.find(p => p.id === periodId);
            if (period) {
                setPayPeriod(period);
            }
        }

        function onCustomDateChange() {
            document.getElementById('payPeriodSelect').value = '';
            selectedPayPeriod = null;
            localStorage.removeItem('selectedPayPeriod');
            document.getElementById('payPeriodInfo').style.display = 'none';
            updateDisplay();
        }

        function updatePayPeriodInfo() {
            if (!selectedPayPeriod) {
                document.getElementById('payPeriodInfo').style.display = 'none';
                return;
            }

            const startDate = new Date(selectedPayPeriod.periodStart);
            const endDate = new Date(selectedPayPeriod.periodEnd);
            const today = new Date();
            
            // Reset time to midnight for accurate day calculations
            const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const startMidnight = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const endMidnight = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            
            const workingDays = calculateWorkingDays(startDate, endDate);
            
            // Calculate days remaining more intelligently
            let remainingDaysText;
            let remainingDaysValue;
            
            if (todayMidnight > endMidnight) {
                // Period is in the past
                remainingDaysText = "Completed";
                remainingDaysValue = 0;
            } else if (todayMidnight < startMidnight) {
                // Period is in the future
                const daysUntilStart = Math.ceil((startMidnight - todayMidnight) / (1000 * 60 * 60 * 24));
                remainingDaysText = `Starts in ${daysUntilStart} days`;
                remainingDaysValue = daysUntilStart;
            } else {
                // Period is current (today is within the period)
                const actualRemainingDays = Math.ceil((endMidnight - todayMidnight) / (1000 * 60 * 60 * 24));
                remainingDaysText = actualRemainingDays.toString();
                remainingDaysValue = actualRemainingDays;
            }
            
            document.getElementById('periodDisplay').textContent = `${selectedPayPeriod.periodStart} to ${selectedPayPeriod.periodEnd}`;
            document.getElementById('timesheetDue').textContent = selectedPayPeriod.timesheetDue || 'N/A';
            document.getElementById('payDay').textContent = selectedPayPeriod.payDay || 'N/A';
            document.getElementById('workingDays').textContent = workingDays;
            document.getElementById('daysRemaining').textContent = remainingDaysText;
            
            document.getElementById('payPeriodInfo').style.display = 'block';
            
            console.log('Pay period info updated:', {
                period: selectedPayPeriod.id,
                start: selectedPayPeriod.periodStart,
                end: selectedPayPeriod.periodEnd,
                today: todayMidnight.toISOString().split('T')[0],
                remainingDays: remainingDaysText,
                workingDays: workingDays
            });
        }

        function calculateWorkingDays(startDate, endDate) {
            let workingDays = 0;
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const isHoliday = companyHolidays.some(holiday => holiday.date === dateStr);
                    
                    if (!isHoliday) {
                        workingDays++;
                    }
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return workingDays;
        }

        // Timer functionality
        function toggleTimer() {
            if (isRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            const category = document.getElementById('categorySelect').value;
            const project = document.getElementById('projectInput').value.trim();
            
            currentSession = {
                startTime: Date.now(),
                category: category,
                project: project || 'General'
            };
            
            isRunning = true;
            document.getElementById('timerButton').textContent = 'Stop';
            document.getElementById('timerButton').className = 'timer-button stop';
            
            timerInterval = setInterval(updateTimer, 1000);
            
            saveActiveSession();
            console.log('Timer started:', currentSession);
        }

        function stopTimer() {
            if (!currentSession) return;
            
            const endTime = Date.now();
            const duration = (endTime - currentSession.startTime) / (1000 * 60 * 60);
            
            const entry = {
                id: Date.now().toString(),
                date: new Date().toISOString().split('T')[0],
                startTime: new Date(currentSession.startTime).toLocaleTimeString(),
                endTime: new Date(endTime).toLocaleTimeString(),
                duration: Math.round(duration * 100) / 100,
                category: currentSession.category,
                project: currentSession.project
            };
            
            timeEntries.push(entry);
            saveData();
            
            isRunning = false;
            currentSession = null;
            clearInterval(timerInterval);
            
            document.getElementById('timerButton').textContent = 'Start';
            document.getElementById('timerButton').className = 'timer-button start';
            document.getElementById('timerDisplay').textContent = '00:00:00';
            
            updateDisplay();
            clearActiveSession();
            
            console.log('Timer stopped, entry added:', entry);
        }

        function updateTimer() {
            if (!currentSession) return;
            
            const now = Date.now();
            const elapsed = now - currentSession.startTime;
            
            const hours = Math.floor(elapsed / (1000 * 60 * 60));
            const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
            
            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
            
            updateDailyCounter();
            
            if (seconds % 30 === 0) {
                saveActiveSession();
            }
        }

        // Session recovery
        function saveActiveSession() {
            if (currentSession) {
                localStorage.setItem('activeSession', JSON.stringify(currentSession));
            }
        }

        function clearActiveSession() {
            localStorage.removeItem('activeSession');
        }

        function recoverSession() {
            const saved = localStorage.getItem('activeSession');
            if (saved) {
                const session = JSON.parse(saved);
                const now = Date.now();
                const elapsed = now - session.startTime;
                const maxSessionTime = 12 * 60 * 60 * 1000;
                
                if (elapsed < maxSessionTime) {
                    if (confirm(`Found an active session from ${new Date(session.startTime).toLocaleString()}.\nCategory: ${session.category}\nProject: ${session.project}\n\nWould you like to continue this session?`)) {
                        currentSession = session;
                        isRunning = true;
                        document.getElementById('timerButton').textContent = 'Stop';
                        document.getElementById('timerButton').className = 'timer-button stop';
                        document.getElementById('categorySelect').value = session.category;
                        document.getElementById('projectInput').value = session.project;
                        
                        timerInterval = setInterval(updateTimer, 1000);
                        updateTimer();
                        
                        console.log('Session recovered:', session);
                        return;
                    }
                }
                clearActiveSession();
            }
        }

        // Data management
        function loadData() {
            try {
                const saved = localStorage.getItem('timeTrackerData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed)) {
                        timeEntries = parsed;
                    } else {
                        console.warn('Invalid time entries data, resetting');
                        timeEntries = [];
                        localStorage.removeItem('timeTrackerData');
                    }
                } else {
                    timeEntries = [];
                }
            } catch (error) {
                console.error('Error loading data:', error);
                timeEntries = [];
                localStorage.removeItem('timeTrackerData');
            }
        }

        function saveData() {
            try {
                localStorage.setItem('timeTrackerData', JSON.stringify(timeEntries));
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Error saving data. Browser storage may be full.');
            }
        }

        function saveSettings() {
            const settings = {
                employeeName: document.getElementById('employeeName').value,
                dailyTarget: document.getElementById('dailyTarget').value
            };
            localStorage.setItem('timeTrackerSettings', JSON.stringify(settings));
            dailyTarget = parseFloat(settings.dailyTarget || 8);
        }

        function loadSettings() {
            const saved = localStorage.getItem('timeTrackerSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('employeeName').value = settings.employeeName || '';
                document.getElementById('dailyTarget').value = settings.dailyTarget || 8;
                dailyTarget = parseFloat(settings.dailyTarget || 8);
            }
        }

        // Display updates
        function updateDisplay() {
            updateStats();
            updateDailyCounter();
            updateEntriesList();
        }

        function updateStats() {
            const filteredEntries = getFilteredEntries();
            const totalHours = filteredEntries.reduce((sum, entry) => sum + entry.duration, 0);
            const workDays = new Set(filteredEntries.map(entry => entry.date)).size;
            const avgDaily = workDays > 0 ? totalHours / workDays : 0;
            
            document.getElementById('totalHours').textContent = totalHours.toFixed(1);
            document.getElementById('workDays').textContent = workDays;
            document.getElementById('avgDaily').textContent = avgDaily.toFixed(1);
            
            const startDate = new Date(document.getElementById('periodStart').value);
            const endDate = new Date(document.getElementById('periodEnd').value);
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('daysElapsed').textContent = daysDiff;
        }

        function updateDailyCounter() {
            const today = new Date().toISOString().split('T')[0];
            const todayEntries = timeEntries.filter(entry => entry.date === today);
            let todayHours = todayEntries.reduce((sum, entry) => sum + entry.duration, 0);
            
            if (isRunning && currentSession) {
                const elapsed = (Date.now() - currentSession.startTime) / (1000 * 60 * 60);
                todayHours += elapsed;
            }
            
            const target = parseFloat(document.getElementById('dailyTarget').value) || 8;
            const progress = Math.min((todayHours / target) * 100, 100);
            
            document.getElementById('dailyCounter').textContent = `${todayHours.toFixed(1)} / ${target}h`;
            document.getElementById('progressFillSmall').style.width = `${progress}%`;
        }

        function getFilteredEntries() {
            const startDate = document.getElementById('periodStart').value;
            const endDate = document.getElementById('periodEnd').value;
            
            if (!startDate || !endDate) return timeEntries;
            
            return timeEntries.filter(entry => {
                return entry.date >= startDate && entry.date <= endDate;
            });
        }

        function updateEntriesList() {
            const container = document.getElementById('entriesList');
            const filteredEntries = getFilteredEntries();
            
            if (filteredEntries.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #7f8c8d;">No time entries for this period.</div>';
                return;
            }
            
            if (currentView === 'detailed') {
                container.innerHTML = filteredEntries
                    .sort((a, b) => new Date(b.date + 'T' + b.startTime) - new Date(a.date + 'T' + a.startTime))
                    .map(entry => `
                        <div class="entry-item">
                            <div class="entry-info">
                                <strong>${entry.date}</strong> | ${entry.startTime} - ${entry.endTime}<br>
                                <small style="color: #6c757d;">${entry.category} ‚Ä¢ ${entry.project}</small>
                            </div>
                            <div class="entry-time">${entry.duration.toFixed(1)}h</div>
                        </div>
                    `).join('');
            } else {
                const dailyTotals = {};
                filteredEntries.forEach(entry => {
                    if (!dailyTotals[entry.date]) {
                        dailyTotals[entry.date] = 0;
                    }
                    dailyTotals[entry.date] += entry.duration;
                });
                
                container.innerHTML = Object.entries(dailyTotals)
                    .sort(([a], [b]) => new Date(b) - new Date(a))
                    .map(([date, hours]) => `
                        <div class="entry-item">
                            <div class="entry-info">
                                <strong>${date}</strong><br>
                                <small style="color: #6c757d;">${new Date(date).toLocaleDateString('en-US', { weekday: 'long' })}</small>
                            </div>
                            <div class="entry-time">${hours.toFixed(1)}h</div>
                        </div>
                    `).join('');
            }
        }

        function setView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            updateEntriesList();
        }

        // Export/Import functionality
        function exportToCSV() {
            const employeeName = document.getElementById('employeeName').value || 'Employee';
            const filteredEntries = getFilteredEntries();
            
            if (filteredEntries.length === 0) {
                alert('No data to export for the selected period.');
                return;
            }
            
            const headers = ['Employee Name', 'Date', 'Category', 'Project', 'Start Time', 'End Time', 'Duration (Hours)'];
            const csvContent = [
                headers.join(','),
                ...filteredEntries.map(entry => [
                    `"${employeeName}"`,
                    entry.date,
                    `"${entry.category}"`,
                    `"${entry.project}"`,
                    `"${entry.startTime}"`,
                    `"${entry.endTime}"`,
                    entry.duration
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const startDate = document.getElementById('periodStart').value;
            const endDate = document.getElementById('periodEnd').value;
            const filename = `timesheet_${employeeName.replace(/[^a-zA-Z0-9]/g, '_')}_${startDate}_to_${endDate}.csv`;
            
            a.href = url;
            a.download = filename;
            a.click();
            
            window.URL.revokeObjectURL(url);
        }

        function importCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                        
                        let imported = 0;
                        let skipped = 0;
                        
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                            
                            if (values.length >= 7) {
                                const entry = {
                                    id: Date.now().toString() + '_' + imported,
                                    date: values[1],
                                    category: values[2],
                                    project: values[3],
                                    startTime: values[4],
                                    endTime: values[5],
                                    duration: parseFloat(values[6])
                                };
                                
                                const isDuplicate = timeEntries.some(existing => 
                                    existing.date === entry.date &&
                                    existing.startTime === entry.startTime &&
                                    existing.category === entry.category &&
                                    existing.project === entry.project
                                );
                                
                                if (!isDuplicate) {
                                    timeEntries.push(entry);
                                    imported++;
                                } else {
                                    skipped++;
                                }
                            }
                        }
                        
                        saveData();
                        updateDisplay();
                        
                        alert(`Import complete!\nImported: ${imported} entries\nSkipped (duplicates): ${skipped} entries`);
                        
                    } catch (error) {
                        alert('Error importing CSV file. Please check the file format.');
                        console.error('CSV import error:', error);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all time entries? This action cannot be undone.')) {
                timeEntries = [];
                saveData();
                updateDisplay();
                alert('All data has been cleared.');
            }
        }
    </script>
</body>
</html>