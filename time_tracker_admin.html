<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker Admin Console</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234facfe'><circle cx='12' cy='12' r='10' stroke='%23667eea' stroke-width='2' fill='%234facfe'/><path d='M12 6v6l4 2' stroke='white' stroke-width='2' stroke-linecap='round'/></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            color: white;
        }

        .logo-section {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .logo-text {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 2px;
            background: linear-gradient(45deg, #ffffff, #e3f2fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .logo-tagline {
            font-size: 0.9rem;
            opacity: 0.8;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .control-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .import-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
        }

        .data-management {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: 300;
        }

        .section-subtitle {
            margin-bottom: 20px;
            opacity: 0.9;
            font-size: 1rem;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .primary-button {
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .primary-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .secondary-button {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .secondary-button:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .file-input {
            display: none;
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            color: #2c3e50;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .filters-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .filters-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .filter-group input, .filter-group select {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .view-selector {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .view-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            gap: 10px;
        }

        .view-option input[type="radio"] {
            transform: scale(1.3);
        }

        .view-option label {
            cursor: pointer;
            font-weight: 500;
            color: #2c3e50;
            font-size: 1rem;
        }

        .data-section {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .data-header {
            background: #3498db;
            color: white;
            padding: 20px;
            font-weight: 600;
            font-size: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .export-options {
            display: flex;
            gap: 10px;
        }

        .export-button {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .data-content {
            padding: 20px;
            min-height: 300px;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .no-data-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table th:last-child,
        .data-table td:last-child {
            width: 100px;
            text-align: center;
        }

        .category-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .category-work { background: #e3f2fd; color: #1565c0; }
        .category-overhead { background: #f3e5f5; color: #6a1b9a; }
        .category-travel { background: #e8f5e8; color: #388e3c; }
        .category-pto { background: #fff3e0; color: #ef6c00; }
        .category-sick { background: #ffebee; color: #c62828; }
        .category-holiday { background: #e8f5e8; color: #2e7d32; }
        .category-bereavement { background: #f3e5f5; color: #7b1fa2; }
        .category-jury { background: #e0f2f1; color: #00695c; }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .footer .credits {
            margin: 0;
            font-weight: 500;
        }

        .action-button {
            padding: 6px 10px;
            margin: 0 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #17a2b8;
            color: white;
        }

        .edit-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .save-btn {
            background: #28a745;
            color: white;
        }

        .save-btn:hover {
            background: #218838;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .cancel-btn:hover {
            background: #5a6268;
        }

        .edit-input {
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            max-width: 120px;
        }

        .action-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            background: #17a2b8;
            color: white;
            margin-left: 8px;
        }

        .duplicate-badge {
            background: #ffc107;
            color: #212529;
        }

        .invalid-badge {
            background: #dc3545;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-section">
                <div>
                    <div class="logo-text">NAKUPUNA</div>
                    <div class="logo-tagline">CONSULTING</div>
                </div>
            </div>
            <h1>📊 Time Tracker Admin Console</h1>
            <p>Enterprise-grade team time tracking consolidation and analysis</p>
        </div>

        <div class="main-content">
            <div class="control-section">
                <div class="import-section">
                    <h2 class="section-title">📁 Import Team Data</h2>
                    <p class="section-subtitle">Import multiple CSV timesheets from team members</p>
                    <div class="button-group">
                        <button class="primary-button" id="importButton" onclick="triggerImport()">
                            📥 Import Timesheets
                        </button>
                        <button class="secondary-button" onclick="showSampleData()">
                            📄 Download Sample
                        </button>
                    </div>
                    <input type="file" id="fileInput" class="file-input" multiple accept=".csv" onchange="handleFileImport(event)">
                    <div class="status-message" id="importStatus"></div>
                </div>

                <div class="data-management">
                    <h2 class="section-title">🛠️ Data Management</h2>
                    <p class="section-subtitle">Clean, validate, and manage consolidated data</p>
                    <div class="button-group">
                        <button class="primary-button" onclick="showDataCleanup()">
                            🧹 Clean Data
                        </button>
                        <button class="secondary-button" onclick="validateData()">
                            ✅ Validate
                        </button>
                        <button class="secondary-button" onclick="showDataSummary()">
                            📋 Summary
                        </button>
                        <button class="secondary-button" onclick="clearAllData()">
                            🗑️ Clear All
                        </button>
                    </div>
                </div>
            </div>

            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-value" id="totalEmployees">0</div>
                    <div class="stat-label">Team Members</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalHours">0.0</div>
                    <div class="stat-label">Total Hours</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalProjects">0</div>
                    <div class="stat-label">Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dateRange">-</div>
                    <div class="stat-label">Date Range</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dataQuality">-</div>
                    <div class="stat-label">Data Quality</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastUpdated">-</div>
                    <div class="stat-label">Last Updated</div>
                </div>
            </div>

            <div class="filters-section">
                <div class="filters-title">🔍 Data Filters</div>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>Start Date:</label>
                        <input type="date" id="filterStartDate" onchange="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>End Date:</label>
                        <input type="date" id="filterEndDate" onchange="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Employee:</label>
                        <select id="filterEmployee" onchange="applyFilters()">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Category:</label>
                        <select id="filterCategory" onchange="applyFilters()">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="view-selector">
                <span style="font-weight: 600; color: #2c3e50; font-size: 1.1rem;">View:</span>
                <div class="view-option">
                    <input type="radio" name="viewMode" value="detailed" id="detailedView" checked onchange="switchView()">
                    <label for="detailedView">📋 All Entries</label>
                </div>
                <div class="view-option">
                    <input type="radio" name="viewMode" value="individual" id="individualView" onchange="switchView()">
                    <label for="individualView">👤 By Individual</label>
                </div>
                <div class="view-option">
                    <input type="radio" name="viewMode" value="category" id="categoryView" onchange="switchView()">
                    <label for="categoryView">🏷️ By Category</label>
                </div>
                <div class="view-option">
                    <input type="radio" name="viewMode" value="project" id="projectView" onchange="switchView()">
                    <label for="projectView">📁 By Project</label>
                </div>
                <div class="view-option">
                    <input type="radio" name="viewMode" value="analytics" id="analyticsView" onchange="switchView()">
                    <label for="analyticsView">📈 Analytics</label>
                </div>
            </div>

            <div class="data-section">
                <div class="data-header" id="dataHeader">
                    <span>📋 Team Time Entries</span>
                    <div class="export-options">
                        <button class="export-button" onclick="exportExcel()" title="Export to Excel">
                            📊 Excel
                        </button>
                        <button class="export-button" onclick="exportCSV()" title="Export to CSV">
                            📄 CSV
                        </button>
                        <button class="export-button" onclick="exportJSON()" title="Export to JSON">
                            📋 JSON
                        </button>
                        <button class="export-button" onclick="exportAccess()" title="Export for Access">
                            🗃️ Access
                        </button>
                    </div>
                </div>
                <div class="data-content" id="dataContent">
                    <div class="no-data">
                        <div class="no-data-icon">📂</div>
                        <div>No timesheet data imported yet</div>
                        <div style="font-size: 1rem; margin-top: 10px; opacity: 0.7;">
                            Click "Import Timesheets" to get started
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p class="credits">Time Tracker Admin Console, V2.0, 6/29/2025, Philippe Addelia - Enhanced Edition</p>
        </div>
    </div>

    <!-- Data Cleanup Modal -->
    <div class="modal" id="cleanupModal">
        <div class="modal-content">
            <div class="modal-header">🧹 Data Cleanup Tools</div>
            <div id="cleanupContent">
                <p>Select cleanup operations to perform:</p>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin: 10px 0;">
                        <input type="checkbox" id="removeDuplicates" checked>
                        Remove duplicate entries (same employee, date, time)
                    </label>
                    <label style="display: block; margin: 10px 0;">
                        <input type="checkbox" id="validateTimes">
                        Fix invalid time entries (end before start, etc.)
                    </label>
                    <label style="display: block; margin: 10px 0;">
                        <input type="checkbox" id="standardizeProjects">
                        Standardize project names (remove extra spaces, consistent casing)
                    </label>
                    <label style="display: block; margin: 10px 0;">
                        <input type="checkbox" id="validateDates">
                        Remove entries with invalid dates
                    </label>
                </div>
                <div class="progress-bar" id="cleanupProgress" style="display: none;">
                    <div class="progress-fill" id="cleanupProgressFill"></div>
                </div>
                <div id="cleanupResults" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="performCleanup()">🧹 Clean Data</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let allTimeEntries = [];
        let filteredEntries = [];
        let employees = new Set();
        let projects = new Set();
        let categories = new Set();
        let currentView = 'detailed';
        let duplicateCount = 0;
        let invalidCount = 0;

        // Data persistence functions
        function saveDataToPersistence() {
            try {
                const dataToSave = {
                    allTimeEntries: allTimeEntries,
                    employees: Array.from(employees),
                    projects: Array.from(projects),
                    categories: Array.from(categories),
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('adminConsoleData', JSON.stringify(dataToSave));
                console.log('Data saved to localStorage');
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function loadPersistedData() {
            try {
                const savedData = localStorage.getItem('adminConsoleData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    allTimeEntries = data.allTimeEntries || [];
                    employees = new Set(data.employees || []);
                    projects = new Set(data.projects || []);
                    categories = new Set(data.categories || []);
                    
                    // Re-validate data after loading
                    performDataValidation();
                    
                    console.log(`Loaded ${allTimeEntries.length} entries from localStorage`);
                    
                    if (allTimeEntries.length > 0) {
                        showStatus(`Restored ${allTimeEntries.length} entries from previous session`, 'info', 'importStatus');
                    }
                }
            } catch (error) {
                console.error('Error loading persisted data:', error);
                // Clear corrupted data
                localStorage.removeItem('adminConsoleData');
            }
        }

        function clearPersistedData() {
            try {
                localStorage.removeItem('adminConsoleData');
                console.log('Cleared persisted data');
            } catch (error) {
                console.error('Error clearing persisted data:', error);
            }
        }

        function triggerImport() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const importButton = document.getElementById('importButton');
            const importStatus = document.getElementById('importStatus');
            
            importButton.disabled = true;
            importButton.textContent = '📥 Processing files...';
            showStatus('Processing ' + files.length + ' files...', 'info', 'importStatus');

            processFiles(files);
        }

        async function processFiles(files) {
            allTimeEntries = [];
            employees.clear();
            projects.clear();
            categories.clear();
            duplicateCount = 0;
            invalidCount = 0;

            let processedFiles = 0;
            let totalEntries = 0;
            let errors = [];

            for (let file of files) {
                try {
                    const entries = await processFile(file);
                    allTimeEntries = [...allTimeEntries, ...entries];
                    totalEntries += entries.length;
                    processedFiles++;
                } catch (error) {
                    errors.push(`${file.name}: ${error.message}`);
                }
            }

            // Initial data quality check
            performDataValidation();

            // Update UI
            const importButton = document.getElementById('importButton');
            importButton.disabled = false;
            importButton.textContent = '📥 Import Timesheets';

            if (errors.length > 0) {
                showStatus(`Processed ${processedFiles}/${files.length} files. ${errors.length} errors: ${errors.join(', ')}`, 'error', 'importStatus');
            } else {
                showStatus(`Successfully imported ${totalEntries} entries from ${processedFiles} files!`, 'success', 'importStatus');
            }

            updateStats();
            updateFilters();
            applyFilters();
            
            // Save data to persistence
            saveDataToPersistence();

            // Reset file input
            document.getElementById('fileInput').value = '';
        }

        function processFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const entries = parseCSV(e.target.result, file.name);
                        resolve(entries);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        function parseCSV(csvText, fileName) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) throw new Error('File appears to be empty or invalid');

            const headers = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
            
            // Find column indices
            const columnMap = {
                employee: findColumnIndex(headers, ['employee name', 'employee', 'name']),
                date: findColumnIndex(headers, ['date']),
                category: findColumnIndex(headers, ['category', 'type']),
                project: findColumnIndex(headers, ['project']),
                startTime: findColumnIndex(headers, ['start time', 'start', 'start_time']),
                endTime: findColumnIndex(headers, ['end time', 'end', 'end_time']),
                duration: findColumnIndex(headers, ['duration', 'hours', 'duration (hours)'])
            };

            // Validate required columns
            if (columnMap.date === -1 || columnMap.startTime === -1 || columnMap.endTime === -1) {
                throw new Error('Missing required columns (Date, Start Time, End Time)');
            }

            const entries = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.toLowerCase().includes('summary') || line.toLowerCase().includes('period')) {
                    break; // Stop at summary section
                }

                const values = parseCSVLine(line);
                if (values.length < 3) continue;

                try {
                    const employeeName = cleanCSVValue(values[columnMap.employee]) || extractEmployeeFromFileName(fileName);
                    const category = cleanCSVValue(values[columnMap.category]) || 'work';
                    const project = cleanCSVValue(values[columnMap.project]) || 'No Project';

                    const entry = {
                        id: Date.now() + Math.random(), // Unique ID
                        employee: employeeName,
                        date: cleanCSVValue(values[columnMap.date]),
                        category: category,
                        project: project,
                        startTime: cleanCSVValue(values[columnMap.startTime]),
                        endTime: cleanCSVValue(values[columnMap.endTime]),
                        duration: parseFloat(cleanCSVValue(values[columnMap.duration])) || 0,
                        fileName: fileName,
                        isValid: true,
                        isDuplicate: false
                    };

                    // Basic validation during import
                    const start = new Date(`2000-01-01T${entry.startTime}:00`);
                    const end = new Date(`2000-01-01T${entry.endTime}:00`);
                    const date = new Date(entry.date);
                    const isValidDate = !isNaN(date.getTime()) && entry.date.match(/^\d{4}-\d{2}-\d{2}$/);
                    
                    if (end <= start || !isValidDate || !entry.employee.trim()) {
                        entry.isValid = false;
                    }

                    // Validate entry has minimum required data
                    if (entry.date && entry.startTime && entry.endTime && entry.employee) {
                        entries.push(entry);
                        employees.add(entry.employee);
                        projects.add(entry.project);
                        categories.add(entry.category);
                    } else {
                        invalidCount++;
                    }
                } catch (error) {
                    console.warn('Skipping invalid row:', line);
                    invalidCount++;
                }
            }

            return entries;
        }

        function performDataValidation() {
            duplicateCount = 0;
            invalidCount = 0;
            
            // Reset all validation flags
            allTimeEntries.forEach(entry => {
                entry.isDuplicate = false;
                entry.isValid = true;
            });

            // Check for duplicates
            const seen = new Set();
            allTimeEntries.forEach(entry => {
                const key = `${entry.employee}-${entry.date}-${entry.startTime}-${entry.endTime}`;
                if (seen.has(key)) {
                    entry.isDuplicate = true;
                    duplicateCount++;
                } else {
                    seen.add(key);
                }
            });

            // Validate time logic and other issues
            allTimeEntries.forEach(entry => {
                // Check time logic
                const start = new Date(`2000-01-01T${entry.startTime}:00`);
                const end = new Date(`2000-01-01T${entry.endTime}:00`);
                
                // Check date validity
                const date = new Date(entry.date);
                const isValidDate = !isNaN(date.getTime()) && entry.date.match(/^\d{4}-\d{2}-\d{2}$/);
                
                // Check required fields
                const hasRequiredFields = entry.employee && entry.employee.trim() && 
                                        entry.startTime && entry.endTime && entry.date;
                
                if (end <= start || !isValidDate || !hasRequiredFields) {
                    entry.isValid = false;
                    invalidCount++;
                }
            });
        }

        function extractEmployeeFromFileName(fileName) {
            const match = fileName.match(/^([^-]+)/);
            return match ? match[1].trim() : 'Unknown Employee';
        }

        function findColumnIndex(headers, possibleNames) {
            for (const name of possibleNames) {
                const index = headers.findIndex(h => h.includes(name));
                if (index !== -1) return index;
            }
            return -1;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function cleanCSVValue(value) {
            if (!value) return '';
            return value.toString().trim().replace(/^"/, '').replace(/"$/, '');
        }

        function updateStats() {
            document.getElementById('totalEmployees').textContent = employees.size;
            
            const totalHours = allTimeEntries.reduce((sum, entry) => sum + entry.duration, 0);
            document.getElementById('totalHours').textContent = totalHours.toFixed(1);
            
            document.getElementById('totalProjects').textContent = projects.size;
            
            // Calculate date range
            if (allTimeEntries.length > 0) {
                const dates = allTimeEntries.map(entry => entry.date).sort();
                const startDate = dates[0];
                const endDate = dates[dates.length - 1];
                document.getElementById('dateRange').textContent = startDate === endDate ? startDate : `${startDate} to ${endDate}`;
            } else {
                document.getElementById('dateRange').textContent = '-';
            }

            // Data quality
            const qualityScore = Math.round(((allTimeEntries.length - duplicateCount - invalidCount) / allTimeEntries.length) * 100) || 0;
            document.getElementById('dataQuality').textContent = allTimeEntries.length > 0 ? `${qualityScore}%` : '-';

            // Last updated
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString();
        }

        function updateFilters() {
            const employeeFilter = document.getElementById('filterEmployee');
            const categoryFilter = document.getElementById('filterCategory');

            // Clear existing options (except first)
            employeeFilter.innerHTML = '<option value="">All Employees</option>';
            categoryFilter.innerHTML = '<option value="">All Categories</option>';

            // Add employee options
            [...employees].sort().forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                employeeFilter.appendChild(option);
            });

            // Add category options
            [...categories].sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.toUpperCase();
                categoryFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const employee = document.getElementById('filterEmployee').value;
            const category = document.getElementById('filterCategory').value;

            filteredEntries = allTimeEntries.filter(entry => {
                if (startDate && entry.date < startDate) return false;
                if (endDate && entry.date > endDate) return false;
                if (employee && entry.employee !== employee) return false;
                if (category && entry.category !== category) return false;
                return true;
            });

            switchView();
        }

        function switchView() {
            currentView = document.querySelector('input[name="viewMode"]:checked')?.value || 'detailed';
            
            const headers = {
                detailed: '📋 All Team Entries',
                individual: '👤 Summary by Individual',
                category: '🏷️ Summary by Category', 
                project: '📁 Summary by Project',
                analytics: '📈 Analytics Dashboard'
            };

            document.getElementById('dataHeader').querySelector('span').textContent = headers[currentView];

            switch (currentView) {
                case 'detailed':
                    showDetailedView();
                    break;
                case 'individual':
                    showIndividualView();
                    break;
                case 'category':
                    showCategoryView();
                    break;
                case 'project':
                    showProjectView();
                    break;
                case 'analytics':
                    showAnalyticsView();
                    break;
            }
        }

        function showDetailedView() {
            const content = document.getElementById('dataContent');
            
            if (filteredEntries.length === 0) {
                content.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">📂</div>
                        <div>No entries match current filters</div>
                    </div>
                `;
                return;
            }

            // Sort by date and employee
            const sortedEntries = [...filteredEntries].sort((a, b) => {
                if (a.date !== b.date) return new Date(b.date) - new Date(a.date);
                if (a.employee !== b.employee) return a.employee.localeCompare(b.employee);
                return a.startTime.localeCompare(b.startTime);
            });

            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Project</th>
                            <th>Time Period</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedEntries.map(entry => `
                            <tr id="entry-row-${entry.id}">
                                <td><strong>${entry.employee}</strong></td>
                                <td>${entry.date}</td>
                                <td><span class="category-badge category-${entry.category}">${entry.category.toUpperCase()}</span></td>
                                <td>${entry.project}</td>
                                <td>${entry.startTime} - ${entry.endTime}</td>
                                <td><strong>${entry.duration}h</strong></td>
                                <td>
                                    ${entry.isDuplicate ? '<span class="action-badge duplicate-badge">DUPLICATE</span>' : ''}
                                    ${!entry.isValid ? '<span class="action-badge invalid-badge">INVALID</span>' : ''}
                                    ${entry.isValid && !entry.isDuplicate ? '<span class="action-badge">VALID</span>' : ''}
                                </td>
                                <td>
                                    <button class="action-button edit-btn" onclick="editEntry('${entry.id}')" title="Edit Entry">✏️</button>
                                    <button class="action-button delete-btn" onclick="deleteEntry('${entry.id}')" title="Delete Entry">🗑️</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            content.innerHTML = table;
        }

        function showIndividualView() {
            const content = document.getElementById('dataContent');
            
            if (filteredEntries.length === 0) {
                content.innerHTML = `<div class="no-data"><div class="no-data-icon">👤</div><div>No employee data to summarize</div></div>`;
                return;
            }

            // Group by employee
            const byEmployee = {};
            filteredEntries.forEach(entry => {
                if (!byEmployee[entry.employee]) {
                    byEmployee[entry.employee] = {
                        totalHours: 0,
                        categories: {},
                        projects: new Set(),
                        entries: 0,
                        validEntries: 0,
                        duplicates: 0
                    };
                }
                
                byEmployee[entry.employee].totalHours += entry.duration;
                byEmployee[entry.employee].entries++;
                byEmployee[entry.employee].projects.add(entry.project);
                
                if (entry.isValid && !entry.isDuplicate) byEmployee[entry.employee].validEntries++;
                if (entry.isDuplicate) byEmployee[entry.employee].duplicates++;
                
                if (!byEmployee[entry.employee].categories[entry.category]) {
                    byEmployee[entry.employee].categories[entry.category] = 0;
                }
                byEmployee[entry.employee].categories[entry.category] += entry.duration;
            });

            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Total Hours</th>
                            <th>Entries</th>
                            <th>Projects</th>
                            <th>Category Breakdown</th>
                            <th>Data Quality</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(byEmployee).map(([employee, data]) => `
                            <tr>
                                <td><strong>${employee}</strong></td>
                                <td><strong>${data.totalHours.toFixed(1)}h</strong></td>
                                <td>${data.entries}</td>
                                <td>${data.projects.size}</td>
                                <td>
                                    ${Object.entries(data.categories).map(([cat, hours]) => 
                                        `<span class="category-badge category-${cat}">${cat.toUpperCase()}: ${hours.toFixed(1)}h</span>`
                                    ).join(' ')}
                                </td>
                                <td>
                                    <span class="action-badge">${data.validEntries} VALID</span>
                                    ${data.duplicates > 0 ? `<span class="action-badge duplicate-badge">${data.duplicates} DUP</span>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            content.innerHTML = table;
        }

        function showCategoryView() {
            const content = document.getElementById('dataContent');
            
            if (filteredEntries.length === 0) {
                content.innerHTML = `<div class="no-data"><div class="no-data-icon">🏷️</div><div>No category data to summarize</div></div>`;
                return;
            }

            // Group by category
            const byCategory = {};
            filteredEntries.forEach(entry => {
                if (!byCategory[entry.category]) {
                    byCategory[entry.category] = {
                        totalHours: 0,
                        employees: new Set(),
                        projects: new Set(),
                        entries: 0
                    };
                }
                
                byCategory[entry.category].totalHours += entry.duration;
                byCategory[entry.category].entries++;
                byCategory[entry.category].employees.add(entry.employee);
                byCategory[entry.category].projects.add(entry.project);
            });

            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Total Hours</th>
                            <th>Entries</th>
                            <th>Employees</th>
                            <th>Projects</th>
                            <th>Avg Hours/Entry</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(byCategory)
                            .sort((a, b) => b[1].totalHours - a[1].totalHours)
                            .map(([category, data]) => `
                            <tr>
                                <td><span class="category-badge category-${category}">${category.toUpperCase()}</span></td>
                                <td><strong>${data.totalHours.toFixed(1)}h</strong></td>
                                <td>${data.entries}</td>
                                <td>${data.employees.size}</td>
                                <td>${data.projects.size}</td>
                                <td>${(data.totalHours / data.entries).toFixed(1)}h</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            content.innerHTML = table;
        }

        function showProjectView() {
            const content = document.getElementById('dataContent');
            
            if (filteredEntries.length === 0) {
                content.innerHTML = `<div class="no-data"><div class="no-data-icon">📁</div><div>No project data to summarize</div></div>`;
                return;
            }

            // Group by project
            const byProject = {};
            filteredEntries.forEach(entry => {
                if (!byProject[entry.project]) {
                    byProject[entry.project] = {
                        totalHours: 0,
                        employees: new Set(),
                        categories: {},
                        entries: 0
                    };
                }
                
                byProject[entry.project].totalHours += entry.duration;
                byProject[entry.project].entries++;
                byProject[entry.project].employees.add(entry.employee);
                
                if (!byProject[entry.project].categories[entry.category]) {
                    byProject[entry.project].categories[entry.category] = 0;
                }
                byProject[entry.project].categories[entry.category] += entry.duration;
            });

            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Total Hours</th>
                            <th>Employees</th>
                            <th>Entries</th>
                            <th>Category Breakdown</th>
                            <th>Avg Hours/Employee</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(byProject)
                            .sort((a, b) => b[1].totalHours - a[1].totalHours)
                            .map(([project, data]) => `
                            <tr>
                                <td><strong>${project}</strong></td>
                                <td><strong>${data.totalHours.toFixed(1)}h</strong></td>
                                <td>${data.employees.size}</td>
                                <td>${data.entries}</td>
                                <td>
                                    ${Object.entries(data.categories).map(([cat, hours]) => 
                                        `<span class="category-badge category-${cat}">${cat.toUpperCase()}: ${hours.toFixed(1)}h</span>`
                                    ).join(' ')}
                                </td>
                                <td>${(data.totalHours / data.employees.size).toFixed(1)}h</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            content.innerHTML = table;
        }

        function showAnalyticsView() {
            const content = document.getElementById('dataContent');
            
            if (filteredEntries.length === 0) {
                content.innerHTML = `<div class="no-data"><div class="no-data-icon">📈</div><div>No data for analytics</div></div>`;
                return;
            }

            // Calculate analytics
            const totalHours = filteredEntries.reduce((sum, entry) => sum + entry.duration, 0);
            const avgDailyHours = totalHours / employees.size;
            const maxProject = Object.entries(
                filteredEntries.reduce((acc, entry) => {
                    acc[entry.project] = (acc[entry.project] || 0) + entry.duration;
                    return acc;
                }, {})
            ).sort((a, b) => b[1] - a[1])[0];

            // Weekly trends
            const weeklyData = {};
            filteredEntries.forEach(entry => {
                const date = new Date(entry.date);
                const week = `${date.getFullYear()}-W${Math.ceil((date.getDate() + new Date(date.getFullYear(), 0, 1).getDay()) / 7)}`;
                weeklyData[week] = (weeklyData[week] || 0) + entry.duration;
            });

            const analytics = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-value">${avgDailyHours.toFixed(1)}h</div>
                        <div class="stat-label">Avg Hours/Employee</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${maxProject ? maxProject[1].toFixed(1) : 0}h</div>
                        <div class="stat-label">Top Project Hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Object.keys(weeklyData).length}</div>
                        <div class="stat-label">Weeks of Data</div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">📊 Key Insights</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4>🎯 Most Active Project:</h4>
                            <p><strong>${maxProject ? maxProject[0] : 'None'}</strong> (${maxProject ? maxProject[1].toFixed(1) : 0} hours)</p>
                        </div>
                        <div>
                            <h4>📈 Data Quality Score:</h4>
                            <p><strong>${Math.round(((filteredEntries.length - duplicateCount - invalidCount) / filteredEntries.length) * 100) || 0}%</strong> (${filteredEntries.length - duplicateCount - invalidCount} valid entries)</p>
                        </div>
                    </div>
                </div>

                <div style="background: #fff; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">📅 Weekly Hours Breakdown</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Total Hours</th>
                                <th>Avg Daily Hours</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(weeklyData)
                                .sort((a, b) => a[0].localeCompare(b[0]))
                                .map(([week, hours]) => `
                                <tr>
                                    <td><strong>${week}</strong></td>
                                    <td>${hours.toFixed(1)}h</td>
                                    <td>${(hours / 7).toFixed(1)}h</td>
                                    <td>
                                        ${hours >= 35 ? '<span class="action-badge">FULL WEEK</span>' : 
                                          hours >= 20 ? '<span class="action-badge duplicate-badge">PARTIAL</span>' : 
                                          '<span class="action-badge invalid-badge">LOW</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            content.innerHTML = analytics;
        }

        // Export functions
        function exportExcel() {
            if (filteredEntries.length === 0) {
                alert('No data to export');
                return;
            }

            const wb = XLSX.utils.book_new();
            
            // Main data sheet
            const wsData = generateExcelData();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Time Entries");

            // Summary sheet
            const summaryData = generateSummaryData();
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

            // Analytics sheet
            const analyticsData = generateAnalyticsData();
            const wsAnalytics = XLSX.utils.aoa_to_sheet(analyticsData);
            XLSX.utils.book_append_sheet(wb, wsAnalytics, "Analytics");

            const filename = `Team_Timesheet_${currentView}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function generateExcelData() {
            const headers = ['Employee', 'Date', 'Category', 'Project', 'Start Time', 'End Time', 'Duration (Hours)', 'Status'];
            const data = [headers];
            
            filteredEntries.forEach(entry => {
                const status = entry.isDuplicate ? 'DUPLICATE' : (!entry.isValid ? 'INVALID' : 'VALID');
                data.push([
                    entry.employee,
                    entry.date,
                    entry.category.toUpperCase(),
                    entry.project,
                    entry.startTime,
                    entry.endTime,
                    entry.duration,
                    status
                ]);
            });

            return data;
        }

        function generateSummaryData() {
            const headers = ['Employee', 'Total Hours', 'Entries', 'Projects', 'Valid Entries', 'Data Quality %'];
            const data = [headers];
            
            const byEmployee = {};
            filteredEntries.forEach(entry => {
                if (!byEmployee[entry.employee]) {
                    byEmployee[entry.employee] = {
                        totalHours: 0,
                        projects: new Set(),
                        entries: 0,
                        validEntries: 0
                    };
                }
                
                byEmployee[entry.employee].totalHours += entry.duration;
                byEmployee[entry.employee].entries++;
                byEmployee[entry.employee].projects.add(entry.project);
                if (entry.isValid && !entry.isDuplicate) byEmployee[entry.employee].validEntries++;
            });

            Object.entries(byEmployee).forEach(([employee, stats]) => {
                const qualityPercent = Math.round((stats.validEntries / stats.entries) * 100);
                data.push([
                    employee,
                    stats.totalHours.toFixed(1),
                    stats.entries,
                    stats.projects.size,
                    stats.validEntries,
                    qualityPercent
                ]);
            });

            return data;
        }

        function generateAnalyticsData() {
            const data = [
                ['Analytics Summary', ''],
                ['Total Employees', employees.size],
                ['Total Hours', filteredEntries.reduce((sum, entry) => sum + entry.duration, 0).toFixed(1)],
                ['Total Projects', projects.size],
                ['Total Categories', categories.size],
                ['Valid Entries', filteredEntries.filter(e => e.isValid && !e.isDuplicate).length],
                ['Duplicate Entries', duplicateCount],
                ['Invalid Entries', invalidCount],
                ['Data Quality Score', `${Math.round(((filteredEntries.length - duplicateCount - invalidCount) / filteredEntries.length) * 100) || 0}%`],
                [''],
                ['Top Projects by Hours', ''],
            ];

            // Add top projects
            const projectHours = {};
            filteredEntries.forEach(entry => {
                projectHours[entry.project] = (projectHours[entry.project] || 0) + entry.duration;
            });

            Object.entries(projectHours)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .forEach(([project, hours]) => {
                    data.push([project, hours.toFixed(1)]);
                });

            return data;
        }

        function exportCSV() {
            if (filteredEntries.length === 0) {
                alert('No data to export');
                return;
            }

            let csvContent = 'Employee,Date,Category,Project,Start Time,End Time,Duration (Hours),Status\n';
            
            filteredEntries.forEach(entry => {
                const status = entry.isDuplicate ? 'DUPLICATE' : (!entry.isValid ? 'INVALID' : 'VALID');
                csvContent += `"${entry.employee}","${entry.date}","${entry.category}","${entry.project}","${entry.startTime}","${entry.endTime}",${entry.duration},"${status}"\n`;
            });

            downloadFile(csvContent, `Team_Timesheet_${currentView}_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function exportJSON() {
            if (filteredEntries.length === 0) {
                alert('No data to export');
                return;
            }

            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    totalEntries: filteredEntries.length,
                    employees: employees.size,
                    projects: projects.size,
                    categories: categories.size,
                    dataQuality: Math.round(((filteredEntries.length - duplicateCount - invalidCount) / filteredEntries.length) * 100) || 0
                },
                entries: filteredEntries
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, `Team_Timesheet_${currentView}_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function exportAccess() {
            if (filteredEntries.length === 0) {
                alert('No data to export');
                return;
            }

            // Create Access-compatible CSV with proper headers and data types
            let csvContent = 'EmployeeID,EmployeeName,WorkDate,Category,Project,StartTime,EndTime,DurationHours,EntryStatus,RecordID\n';
            
            filteredEntries.forEach((entry, index) => {
                const status = entry.isDuplicate ? 'DUPLICATE' : (!entry.isValid ? 'INVALID' : 'VALID');
                const employeeID = Array.from(employees).indexOf(entry.employee) + 1;
                csvContent += `${employeeID},"${entry.employee}","${entry.date}","${entry.category}","${entry.project}","${entry.startTime}","${entry.endTime}",${entry.duration},"${status}",${index + 1}\n`;
            });

            // Add creation script
            let accessScript = `-- Microsoft Access Import Script
-- Run this after importing the CSV file

-- Create table structure (if needed)
CREATE TABLE TimeEntries (
    RecordID COUNTER PRIMARY KEY,
    EmployeeID LONG,
    EmployeeName TEXT(100),
    WorkDate DATETIME,
    Category TEXT(50),
    Project TEXT(100),
    StartTime DATETIME,
    EndTime DATETIME,
    DurationHours DOUBLE,
    EntryStatus TEXT(20)
);

-- Create indexes for better performance
CREATE INDEX idx_employee ON TimeEntries (EmployeeID);
CREATE INDEX idx_date ON TimeEntries (WorkDate);
CREATE INDEX idx_project ON TimeEntries (Project);

-- Sample queries
-- Total hours by employee:
-- SELECT EmployeeName, SUM(DurationHours) AS TotalHours FROM TimeEntries GROUP BY EmployeeName;

-- Hours by project:
-- SELECT Project, SUM(DurationHours) AS ProjectHours FROM TimeEntries GROUP BY Project ORDER BY ProjectHours DESC;
`;

            // Create ZIP-like content (as text files)
            const zipContent = `=== TIME TRACKER DATA FOR MICROSOFT ACCESS ===

Files included:
1. timesheet_data.csv - Main data file for import
2. access_setup.sql - Database setup script

Import Instructions:
1. Open Microsoft Access
2. Create new database or open existing
3. Go to External Data > Text File
4. Import timesheet_data.csv
5. Run access_setup.sql queries as needed

Data Quality: ${Math.round(((filteredEntries.length - duplicateCount - invalidCount) / filteredEntries.length) * 100) || 0}%
Total Records: ${filteredEntries.length}
Export Date: ${new Date().toISOString()}

=== CSV DATA BEGINS BELOW ===

${csvContent}

=== SQL SCRIPT BEGINS BELOW ===

${accessScript}`;

            downloadFile(zipContent, `Team_Timesheet_Access_${new Date().toISOString().split('T')[0]}.txt`, 'text/plain');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // Data management functions
        function showDataCleanup() {
            document.getElementById('cleanupModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('cleanupModal').style.display = 'none';
        }

        function performCleanup() {
            const removeDuplicates = document.getElementById('removeDuplicates').checked;
            const validateTimes = document.getElementById('validateTimes').checked;
            const standardizeProjects = document.getElementById('standardizeProjects').checked;
            const validateDates = document.getElementById('validateDates').checked;

            const progressBar = document.getElementById('cleanupProgress');
            const progressFill = document.getElementById('cleanupProgressFill');
            const resultsDiv = document.getElementById('cleanupResults');

            progressBar.style.display = 'block';
            let progress = 0;
            let results = [];
            let removedCount = 0;
            let fixedCount = 0;
            let initialCount = allTimeEntries.length;

            // Perform cleanup operations
            if (removeDuplicates) {
                const beforeCount = allTimeEntries.length;
                removedCount += removeDuplicateEntries();
                results.push(`🔍 Removed ${beforeCount - allTimeEntries.length} duplicate entries`);
                progress += 25;
                progressFill.style.width = progress + '%';
            }

            if (validateDates) {
                const beforeCount = allTimeEntries.length;
                removedCount += removeInvalidDates();
                results.push(`📅 Removed ${beforeCount - allTimeEntries.length} entries with invalid dates`);
                progress += 25;
                progressFill.style.width = progress + '%';
            }

            if (validateTimes) {
                const fixedTimes = fixInvalidTimes();
                fixedCount += fixedTimes;
                results.push(`⏰ Fixed ${fixedTimes} entries with invalid times`);
                progress += 25;
                progressFill.style.width = progress + '%';
            }

            if (standardizeProjects) {
                const standardizedProjects = standardizeProjectNames();
                fixedCount += standardizedProjects;
                results.push(`📁 Standardized ${standardizedProjects} project names`);
                progress += 25;
                progressFill.style.width = progress + '%';
            }

            // Final progress
            progressFill.style.width = '100%';

            // Re-validate all data after cleanup
            performDataValidation();
            
            // Update UI elements
            updateEmployeesAndProjects();
            updateStats();
            updateFilters();
            applyFilters();
            
            // Save cleaned data
            saveDataToPersistence();

            // Show results
            results.push(`✅ Cleanup completed successfully!`);
            results.push(`📊 Started with ${initialCount} entries`);
            results.push(`🗑️ Removed ${removedCount} problematic entries`);
            results.push(`🔧 Fixed ${fixedCount} entries`);
            results.push(`📈 Final count: ${allTimeEntries.length} entries`);
            
            const newQuality = Math.round(((allTimeEntries.length - duplicateCount - invalidCount) / allTimeEntries.length) * 100) || 0;
            results.push(`🎯 New data quality: ${newQuality}%`);
            
            resultsDiv.innerHTML = results.join('<br>');
            resultsDiv.style.display = 'block';
            
            // Show success status after brief delay
            setTimeout(() => {
                const newQuality = Math.round(((allTimeEntries.length - duplicateCount - invalidCount) / allTimeEntries.length) * 100) || 0;
                if (newQuality > 90) {
                    showStatus(`Cleanup completed! Quality improved to ${newQuality}%`, 'success', 'importStatus');
                } else {
                    showStatus('Cleanup completed successfully', 'success', 'importStatus');
                }
            }, 1000); // Delay to show completion
        }

        function updateEmployeesAndProjects() {
            employees.clear();
            projects.clear();
            categories.clear();
            
            allTimeEntries.forEach(entry => {
                employees.add(entry.employee);
                projects.add(entry.project);
                categories.add(entry.category);
            });
        }

        function removeDuplicateEntries() {
            const seen = new Set();
            const originalLength = allTimeEntries.length;
            
            allTimeEntries = allTimeEntries.filter(entry => {
                const key = `${entry.employee}-${entry.date}-${entry.startTime}-${entry.endTime}`;
                if (seen.has(key)) {
                    return false; // Remove duplicate
                } else {
                    seen.add(key);
                    entry.isDuplicate = false; // Mark as no longer duplicate
                    return true; // Keep original
                }
            });
            
            return originalLength - allTimeEntries.length;
        }

        function fixInvalidTimes() {
            let fixedCount = 0;
            
            allTimeEntries.forEach(entry => {
                const start = new Date(`2000-01-01T${entry.startTime}:00`);
                const end = new Date(`2000-01-01T${entry.endTime}:00`);
                
                if (end <= start) {
                    // Swap times if end is before start
                    [entry.startTime, entry.endTime] = [entry.endTime, entry.startTime];
                    
                    // Recalculate duration
                    const newStart = new Date(`2000-01-01T${entry.startTime}:00`);
                    const newEnd = new Date(`2000-01-01T${entry.endTime}:00`);
                    entry.duration = Math.round(((newEnd - newStart) / 3600000) * 100) / 100; // Round to 2 decimals
                    
                    entry.isValid = true; // Mark as now valid
                    fixedCount++;
                }
            });
            
            return fixedCount;
        }

        function standardizeProjectNames() {
            let fixedCount = 0;
            
            allTimeEntries.forEach(entry => {
                const original = entry.project;
                // Trim whitespace and standardize casing for first letter
                entry.project = entry.project.trim();
                if (entry.project.length > 0) {
                    entry.project = entry.project.charAt(0).toUpperCase() + entry.project.slice(1);
                }
                if (entry.project !== original) {
                    fixedCount++;
                }
            });
            
            return fixedCount;
        }

        function removeInvalidDates() {
            const originalLength = allTimeEntries.length;
            
            allTimeEntries = allTimeEntries.filter(entry => {
                const date = new Date(entry.date);
                const isValidDate = !isNaN(date.getTime()) && entry.date.match(/^\d{4}-\d{2}-\d{2}$/);
                return isValidDate;
            });
            
            return originalLength - allTimeEntries.length;
        }

        function validateData() {
            performDataValidation();
            
            const validEntries = allTimeEntries.filter(e => e.isValid && !e.isDuplicate).length;
            const qualityScore = Math.round((validEntries / allTimeEntries.length) * 100) || 0;
            
            let message = `Data Validation Complete:\n\n`;
            message += `✅ Valid entries: ${validEntries}\n`;
            message += `⚠️ Duplicate entries: ${duplicateCount}\n`;
            message += `❌ Invalid entries: ${invalidCount}\n`;
            message += `📊 Overall quality: ${qualityScore}%\n\n`;
            
            if (qualityScore < 80) {
                message += `Recommendation: Run data cleanup to improve quality.`;
            } else {
                message += `Great! Your data quality is excellent.`;
            }
            
            alert(message);
            updateStats();
        }

        function showDataSummary() {
            const summary = `
📊 TEAM TIMESHEET SUMMARY

👥 Team: ${employees.size} employees
⏰ Total Hours: ${allTimeEntries.reduce((sum, entry) => sum + entry.duration, 0).toFixed(1)}h
📁 Projects: ${projects.size} unique projects
🏷️ Categories: ${categories.size} categories

📈 Data Quality:
  ✅ Valid entries: ${allTimeEntries.filter(e => e.isValid && !e.isDuplicate).length}
  ⚠️ Duplicates: ${duplicateCount}
  ❌ Invalid: ${invalidCount}
  📊 Quality score: ${Math.round(((allTimeEntries.length - duplicateCount - invalidCount) / allTimeEntries.length) * 100) || 0}%

📅 Date Range: ${allTimeEntries.length > 0 ? 
    (() => {
        const dates = allTimeEntries.map(entry => entry.date).sort();
        return dates[0] === dates[dates.length - 1] ? dates[0] : `${dates[0]} to ${dates[dates.length - 1]}`;
    })() : 'No data'}
            `;
            
            alert(summary);
        }

        function clearAllData() {
            if (allTimeEntries.length === 0) {
                alert('No data to clear.');
                return;
            }
            
            const confirmed = confirm(
                `⚠️ WARNING: This will permanently delete all ${allTimeEntries.length} time entries!\n\n` +
                `This action cannot be undone.\n\n` +
                `Are you sure you want to continue?`
            );
            
            if (confirmed) {
                const finalConfirm = confirm('🚨 FINAL CONFIRMATION\n\nDelete ALL imported timesheet data?');
                if (finalConfirm) {
                    allTimeEntries = [];
                    filteredEntries = [];
                    employees.clear();
                    projects.clear();
                    categories.clear();
                    duplicateCount = 0;
                    invalidCount = 0;
                    
                    // Clear persisted data
                    clearPersistedData();
                    
                    updateStats();
                    updateFilters();
                    switchView();
                    
                    showStatus('All data cleared successfully', 'success', 'importStatus');
                }
            }
        }

        function showStatus(message, type, elementId) {
            const status = document.getElementById(elementId);
            status.textContent = message;
            status.className = `status-message ${type}`;
            status.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        function showSampleData() {
            const sampleCSV = `Employee Name,Date,Category,Project,Start Time,End Time,Duration (Hours)
"John Doe","2025-06-29","work","Project Alpha","09:00","17:00",8.0
"Jane Smith","2025-06-29","overhead","Admin Tasks","08:30","12:30",4.0
"John Doe","2025-06-28","travel","Client Meeting","10:00","14:00",4.0
"Jane Smith","2025-06-28","work","Project Beta","09:00","17:30",8.5`;

            downloadFile(sampleCSV, 'sample_timesheet.csv', 'text/csv');
            showStatus('Sample CSV file downloaded. Use this format for importing team timesheets.', 'info', 'importStatus');
        }

        // Entry management functions
        function editEntry(entryId) {
            const entry = allTimeEntries.find(e => e.id == entryId);
            if (!entry) {
                alert('Entry not found');
                return;
            }

            const row = document.getElementById(`entry-row-${entryId}`);
            if (!row) return;

            // Store original values for cancel functionality
            const original = { ...entry };

            row.innerHTML = `
                <td><input type="text" class="edit-input" id="edit-employee-${entryId}" value="${entry.employee}"></td>
                <td><input type="date" class="edit-input" id="edit-date-${entryId}" value="${entry.date}"></td>
                <td>
                    <select class="edit-input" id="edit-category-${entryId}">
                        <option value="work" ${entry.category === 'work' ? 'selected' : ''}>Work</option>
                        <option value="overhead" ${entry.category === 'overhead' ? 'selected' : ''}>Overhead</option>
                        <option value="travel" ${entry.category === 'travel' ? 'selected' : ''}>Travel</option>
                        <option value="pto" ${entry.category === 'pto' ? 'selected' : ''}>PTO</option>
                        <option value="sick" ${entry.category === 'sick' ? 'selected' : ''}>Sick</option>
                        <option value="holiday" ${entry.category === 'holiday' ? 'selected' : ''}>Holiday</option>
                        <option value="bereavement" ${entry.category === 'bereavement' ? 'selected' : ''}>Bereavement</option>
                        <option value="jury" ${entry.category === 'jury' ? 'selected' : ''}>Jury Duty</option>
                    </select>
                </td>
                <td><input type="text" class="edit-input" id="edit-project-${entryId}" value="${entry.project}"></td>
                <td>
                    <input type="time" class="edit-input" id="edit-start-${entryId}" value="${entry.startTime}" style="width: 70px;">
                    -
                    <input type="time" class="edit-input" id="edit-end-${entryId}" value="${entry.endTime}" style="width: 70px;">
                </td>
                <td><span id="edit-duration-${entryId}">${entry.duration}h</span></td>
                <td><span class="action-badge">EDITING</span></td>
                <td>
                    <button class="action-button save-btn" onclick="saveEntry('${entryId}')" title="Save Changes">💾</button>
                    <button class="action-button cancel-btn" onclick="cancelEdit('${entryId}', ${JSON.stringify(original).replace(/"/g, '&quot;')})" title="Cancel">❌</button>
                </td>
            `;

            // Add event listeners to update duration when times change
            document.getElementById(`edit-start-${entryId}`).addEventListener('change', () => updateEditDuration(entryId));
            document.getElementById(`edit-end-${entryId}`).addEventListener('change', () => updateEditDuration(entryId));
        }

        function updateEditDuration(entryId) {
            const startInput = document.getElementById(`edit-start-${entryId}`);
            const endInput = document.getElementById(`edit-end-${entryId}`);
            const durationSpan = document.getElementById(`edit-duration-${entryId}`);

            if (startInput && endInput && startInput.value && endInput.value) {
                const start = new Date(`2000-01-01T${startInput.value}:00`);
                const end = new Date(`2000-01-01T${endInput.value}:00`);
                
                if (end > start) {
                    const duration = Math.round(((end - start) / 3600000) * 100) / 100;
                    durationSpan.textContent = `${duration}h`;
                } else {
                    durationSpan.textContent = 'Invalid';
                }
            }
        }

        function saveEntry(entryId) {
            const entry = allTimeEntries.find(e => e.id == entryId);
            if (!entry) {
                alert('Entry not found');
                return;
            }

            // Get updated values
            const newEmployee = document.getElementById(`edit-employee-${entryId}`).value.trim();
            const newDate = document.getElementById(`edit-date-${entryId}`).value;
            const newCategory = document.getElementById(`edit-category-${entryId}`).value;
            const newProject = document.getElementById(`edit-project-${entryId}`).value.trim() || 'No Project';
            const newStartTime = document.getElementById(`edit-start-${entryId}`).value;
            const newEndTime = document.getElementById(`edit-end-${entryId}`).value;

            // Validate inputs
            if (!newEmployee || !newDate || !newStartTime || !newEndTime) {
                alert('Please fill in all required fields');
                return;
            }

            const start = new Date(`2000-01-01T${newStartTime}:00`);
            const end = new Date(`2000-01-01T${newEndTime}:00`);
            
            if (end <= start) {
                alert('End time must be after start time');
                return;
            }

            // Update entry
            const oldEmployee = entry.employee;
            const oldProject = entry.project;
            const oldCategory = entry.category;

            entry.employee = newEmployee;
            entry.date = newDate;
            entry.category = newCategory;
            entry.project = newProject;
            entry.startTime = newStartTime;
            entry.endTime = newEndTime;
            entry.duration = Math.round(((end - start) / 3600000) * 100) / 100;
            entry.isValid = true;
            entry.isDuplicate = false; // Will be re-checked in validation

            // Update sets if needed
            employees.add(newEmployee);
            projects.add(newProject);
            categories.add(newCategory);

            // Remove old values if no longer used
            if (oldEmployee !== newEmployee && !allTimeEntries.some(e => e.employee === oldEmployee)) {
                employees.delete(oldEmployee);
            }
            if (oldProject !== newProject && !allTimeEntries.some(e => e.project === oldProject)) {
                projects.delete(oldProject);
            }
            if (oldCategory !== newCategory && !allTimeEntries.some(e => e.category === oldCategory)) {
                categories.delete(oldCategory);
            }

            // Re-validate data and update displays
            performDataValidation();
            updateStats();
            updateFilters();
            saveDataToPersistence();
            switchView(); // Refresh the current view

            showStatus('Entry updated successfully', 'success', 'importStatus');
        }

        function cancelEdit(entryId, originalData) {
            // Restore original data and refresh view
            switchView();
        }

        function deleteEntry(entryId) {
            const entry = allTimeEntries.find(e => e.id == entryId);
            if (!entry) {
                alert('Entry not found');
                return;
            }

            const confirmDelete = confirm(
                `Delete this entry?\n\n` +
                `Employee: ${entry.employee}\n` +
                `Date: ${entry.date}\n` +
                `Project: ${entry.project}\n` +
                `Duration: ${entry.duration}h\n\n` +
                `This action cannot be undone.`
            );

            if (confirmDelete) {
                // Remove entry from array
                const entryIndex = allTimeEntries.findIndex(e => e.id == entryId);
                if (entryIndex > -1) {
                    allTimeEntries.splice(entryIndex, 1);
                }

                // Update sets (remove if no longer used)
                updateEmployeesAndProjects();

                // Update displays
                performDataValidation();
                updateStats();
                updateFilters();
                saveDataToPersistence();
                switchView(); // Refresh the current view

                showStatus('Entry deleted successfully', 'success', 'importStatus');
            }
        }

        // Initialize
        filteredEntries = allTimeEntries;
        updateStats();
        
        // Add notification about data persistence
        console.log('Admin Console initialized with data persistence enabled');
    </script>
</body>
</html>