<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Time Tracker - Standalone Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .company-info h2 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .logo-tagline {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 500;
        }

        h1 {
            color: #2c3e50;
            font-size: 32px;
            text-align: center;
            margin-bottom: 20px;
        }

        .header-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #555;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .pay-period-section {
            background: rgba(46, 204, 113, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #2ecc71;
            margin-top: 10px;
        }

        .pay-period-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
        }

        .pay-period-detail {
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 5px;
        }

        .pay-period-detail .label {
            font-weight: bold;
            color: #27ae60;
            display: block;
            margin-bottom: 2px;
        }

        .pay-period-detail .value {
            color: #2c3e50;
        }

        .config-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .timer-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .timer-display {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .timer-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .timer-button:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .timer-button.start {
            background: #27ae60;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .timer-button.start:hover {
            background: #229954;
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .daily-counter {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .daily-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .daily-progress {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .progress-bar-small {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-small {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            transition: width 0.3s ease;
            width: 0%;
        }

        .category-selector, .project-selector {
            margin: 15px 0;
        }

        .category-selector select, .project-selector input {
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            width: 100%;
        }

        .category-selector select option {
            background: #2c3e50;
            color: white;
        }

        .stats-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .entries-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            grid-column: 1 / -1;
        }

        .view-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .view-button {
            padding: 8px 16px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .view-button.active, .view-button:hover {
            background: #3498db;
            color: white;
        }

        .export-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .export-button {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .export-button:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .entries-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .entry {
            display: grid;
            grid-template-columns: 100px 80px 100px 1fr 80px 80px 60px;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            font-size: 14px;
        }

        .entry:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        .entry:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .entry-actions {
            display: flex;
            gap: 5px;
        }

        .action-button {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .edit-button {
            background: #f39c12;
            color: white;
        }

        .delete-button {
            background: #e74c3c;
            color: white;
        }

        .category-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
        }

        .category-work { background: #3498db; color: white; }
        .category-overhead { background: #9b59b6; color: white; }
        .category-travel { background: #2ecc71; color: white; }
        .category-pto { background: #f39c12; color: white; }
        .category-sick { background: #e74c3c; color: white; }
        .category-holiday { background: #27ae60; color: white; }
        .category-bereavement { background: #8e44ad; color: white; }
        .category-jury { background: #16a085; color: white; }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header-controls {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .timer-display {
                font-size: 36px;
            }
            
            .entry {
                grid-template-columns: 1fr;
                gap: 5px;
                text-align: center;
            }
            
            .view-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo">NC</div>
                    <div class="company-info">
                        <h2>NAKUPUNA</h2>
                        <div class="logo-tagline">CONSULTING</div>
                    </div>
                </div>
            </div>
            <h1>🕐 Employee Time Tracker - Standalone</h1>
            <div class="header-controls">
                <div class="form-group">
                    <label>Employee Name:</label>
                    <input type="text" id="employeeName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Daily Target Hours:</label>
                    <input type="number" id="dailyTarget" value="8" min="1" max="24" step="0.5" onchange="updateDisplay()">
                </div>
                <div class="form-group">
                    <label>Pay Period:</label>
                    <select id="payPeriodSelect" onchange="onPayPeriodChange()">
                        <option value="">Loading pay periods...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Custom Dates (if needed):</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="periodStart" onchange="onCustomDateChange()" style="flex: 1;">
                        <input type="date" id="periodEnd" onchange="onCustomDateChange()" style="flex: 1;">
                    </div>
                </div>
            </div>
            
            <div class="pay-period-section" id="payPeriodInfo" style="display: none;">
                <h3 style="margin-bottom: 10px; color: #27ae60;">📅 Pay Period Information</h3>
                <div class="pay-period-info">
                    <div class="pay-period-detail">
                        <span class="label">Period</span>
                        <span class="value" id="periodDisplay">-</span>
                    </div>
                    <div class="pay-period-detail">
                        <span class="label">Timesheet Due</span>
                        <span class="value" id="timesheetDue">-</span>
                    </div>
                    <div class="pay-period-detail">
                        <span class="label">Pay Day</span>
                        <span class="value" id="payDay">-</span>
                    </div>
                    <div class="pay-period-detail">
                        <span class="label">Working Days</span>
                        <span class="value" id="workingDays">-</span>
                    </div>
                    <div class="pay-period-detail">
                        <span class="label">Days Remaining</span>
                        <span class="value" id="daysRemaining">-</span>
                    </div>
                </div>
            </div>
            
            <div class="config-status" id="configStatus">
                ✅ Standalone mode: Built-in pay periods loaded successfully!
            </div>
        </div>

        <div class="main-content">
            <div class="timer-section">
                <div class="timer-display" id="timerDisplay">00:00:00</div>
                <button class="timer-button start" id="timerButton" onclick="toggleTimer()">Start</button>
                <div class="daily-counter">
                    <div class="daily-label">Today's Progress</div>
                    <div class="daily-progress" id="dailyCounter">0.0 / 8.0h</div>
                    <div class="progress-bar-small">
                        <div class="progress-fill-small" id="progressFillSmall"></div>
                    </div>
                </div>
                <div class="category-selector">
                    <label style="color: rgba(255,255,255,0.9); margin-right: 10px;">Category:</label>
                    <select id="categorySelect">
                        <option value="work">Work</option>
                        <option value="overhead">Overhead</option>
                        <option value="travel">Paid Travel</option>
                        <option value="pto">PTO</option>
                        <option value="sick">Sick Day</option>
                        <option value="holiday">Holiday</option>
                        <option value="bereavement">Bereavement</option>
                        <option value="jury">Jury Duty</option>
                    </select>
                </div>
                <div class="project-selector">
                    <label style="color: rgba(255,255,255,0.9); margin-right: 10px;">Project:</label>
                    <input type="text" id="projectInput" placeholder="Enter project name" style="color: white;">
                </div>
            </div>

            <div class="stats-section">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">📊 Period Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalHours">0.0</div>
                        <div class="stat-label">Total Hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="workDays">0</div>
                        <div class="stat-label">Days Worked</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgDaily">0.0</div>
                        <div class="stat-label">Avg Daily Hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="daysElapsed">0</div>
                        <div class="stat-label">Days in Period</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="entries-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #2c3e50;">📝 Time Entries</h3>
                <div class="export-section">
                    <button class="export-button" onclick="exportToCSV()">📥 Export CSV</button>
                    <button class="export-button" onclick="importCSV()" style="background: #3498db;">📤 Import CSV</button>
                    <button class="export-button" onclick="clearAllData()" style="background: #e74c3c;">🗑️ Clear All</button>
                </div>
            </div>
            
            <div class="view-controls">
                <button class="view-button active" onclick="setView('detailed')">Detailed View</button>
                <button class="view-button" onclick="setView('daily')">Daily Summary</button>
            </div>
            
            <div class="entries-list" id="entriesList">
                <div style="padding: 20px; text-align: center; color: #7f8c8d;">
                    No time entries yet. Start the timer to begin tracking!
                </div>
            </div>
        </div>
    </div>

    <script>
        // Built-in pay periods configuration (no external file needed)
        const BUILTIN_CONFIG = {
            "version": "1.1.1",
            "lastUpdated": "2025-08-17T12:00:00-08:00",
            "company": {
                "name": "Your Company",
                "payrollCycle": "bi-weekly",
                "timeZone": "PST"
            },
            "payPeriods": [
                {
                    "id": "PP-2025-16",
                    "startDate": "2025-08-02",
                    "endDate": "2025-08-15",
                    "timesheetDue": "2025-08-15",
                    "payDay": "2025-08-22",
                    "description": "Pay Period 16 - August 2nd to 15th"
                },
                {
                    "id": "PP-2025-17",
                    "startDate": "2025-08-16",
                    "endDate": "2025-08-29",
                    "timesheetDue": "2025-08-29",
                    "payDay": "2025-09-05",
                    "description": "Pay Period 17 - August 16th to 29th"
                },
                {
                    "id": "PP-2025-18",
                    "startDate": "2025-08-30",
                    "endDate": "2025-09-12",
                    "timesheetDue": "2025-09-12",
                    "payDay": "2025-09-19",
                    "description": "Pay Period 18 - August 30th to September 12th"
                },
                {
                    "id": "PP-2025-19",
                    "startDate": "2025-09-13",
                    "endDate": "2025-09-26",
                    "timesheetDue": "2025-09-26",
                    "payDay": "2025-10-03",
                    "description": "Pay Period 19 - September 13th to 26th"
                },
                {
                    "id": "PP-2025-20",
                    "startDate": "2025-09-27",
                    "endDate": "2025-10-10",
                    "timesheetDue": "2025-10-10",
                    "payDay": "2025-10-17",
                    "description": "Pay Period 20 - September 27th to October 10th"
                },
                {
                    "id": "PP-2025-21",
                    "startDate": "2025-10-11",
                    "endDate": "2025-10-24",
                    "timesheetDue": "2025-10-24",
                    "payDay": "2025-10-31",
                    "description": "Pay Period 21 - October 11th to 24th"
                },
                {
                    "id": "PP-2025-22",
                    "startDate": "2025-10-25",
                    "endDate": "2025-11-07",
                    "timesheetDue": "2025-11-07",
                    "payDay": "2025-11-14",
                    "description": "Pay Period 22 - October 25th to November 7th"
                },
                {
                    "id": "PP-2025-23",
                    "startDate": "2025-11-08",
                    "endDate": "2025-11-21",
                    "timesheetDue": "2025-11-21",
                    "payDay": "2025-11-28",
                    "description": "Pay Period 23 - November 8th to 21st"
                },
                {
                    "id": "PP-2025-24",
                    "startDate": "2025-11-22",
                    "endDate": "2025-12-05",
                    "timesheetDue": "2025-12-05",
                    "payDay": "2025-12-12",
                    "description": "Pay Period 24 - November 22nd to December 5th"
                },
                {
                    "id": "PP-2025-25",
                    "startDate": "2025-12-06",
                    "endDate": "2025-12-19",
                    "timesheetDue": "2025-12-19",
                    "payDay": "2025-12-26",
                    "description": "Pay Period 25 - December 6th to 19th"
                },
                {
                    "id": "PP-2025-26",
                    "startDate": "2025-12-20",
                    "endDate": "2026-01-02",
                    "timesheetDue": "2026-01-02",
                    "payDay": "2026-01-09",
                    "description": "Pay Period 26 - December 20th to January 2nd"
                }
            ],
            "holidays": [
                {
                    "date": "2025-01-01",
                    "name": "New Year's Day",
                    "type": "federal",
                    "observed": true
                },
                {
                    "date": "2025-01-20",
                    "name": "Martin Luther King Jr. Day",
                    "type": "federal",
                    "observed": true
                },
                {
                    "date": "2025-02-17",
                    "name": "Presidents Day",
                    "type": "federal",
                    "observed": true
                },
                {
                    "date": "2025-05-26",
                    "name": "Memorial Day",
                    "type": "federal",
                    "observed": true
                },
                {
                    "date": "2025-07-04",
                    "name": "Independence Day",
                    "type": "federal",
                    "observed": true
                },
                {
                    "date": "2025-09-01",
                    "name": "Labor Day",
                    "type": "federal",
                    "observed": true
                },
                {
                    "date": "2025-11-11",
                    "name": "Veterans Day",
                    "type": "federal",
                    "observed": true
                },
                {
                    "date": "2025-11-27",
                    "name": "Thanksgiving Day",
                    "type": "federal",
                    "observed": true
                },
                {
                    "date": "2025-11-28",
                    "name": "Day After Thanksgiving",
                    "type": "company",
                    "observed": true
                },
                {
                    "date": "2025-12-25",
                    "name": "Christmas Day",
                    "type": "federal",
                    "observed": true
                }
            ]
        };

        // Global variables
        let startTime = null;
        let timerInterval = null;
        let timeEntries = []; // Always initialize as empty array
        let currentView = 'detailed';
        let payPeriodsConfig = null;
        let selectedPayPeriod = null;
        let companyHolidays = [];

        // Load data and config on page load
        window.addEventListener('load', function() {
            console.log('Starting time tracker initialization...');
            console.log('Initial timeEntries state:', timeEntries);
            
            loadBuiltinConfig();
            loadData();
            console.log('After loadData, timeEntries:', timeEntries, 'Type:', typeof timeEntries, 'IsArray:', Array.isArray(timeEntries));
            
            loadSettings();
            updateDisplay();
            setupEventListeners();
            
            console.log('Time tracker initialization complete');
        });

        function setupEventListeners() {
            document.getElementById('employeeName').addEventListener('input', saveSettings);
            document.getElementById('dailyTarget').addEventListener('input', saveSettings);
        }

        // Pay Period Configuration Management (Built-in)
        function loadBuiltinConfig() {
            try {
                payPeriodsConfig = BUILTIN_CONFIG;
                
                // Load holidays if available
                if (payPeriodsConfig.holidays) {
                    companyHolidays = payPeriodsConfig.holidays;
                }
                
                populatePayPeriodDropdown();
                selectCurrentPayPeriod();
                
                console.log('Built-in configuration loaded successfully');
                
            } catch (error) {
                console.error('Failed to load built-in config:', error);
                enableManualDateSelection();
            }
        }

        function populatePayPeriodDropdown() {
            const select = document.getElementById('payPeriodSelect');
            select.innerHTML = '<option value="">-- Select Pay Period --</option>';
            
            if (!payPeriodsConfig || !payPeriodsConfig.payPeriods) return;
            
            payPeriodsConfig.payPeriods.forEach((period, index) => {
                const option = document.createElement('option');
                option.value = period.id;
                option.textContent = `${period.id} (${period.startDate} to ${period.endDate})`;
                select.appendChild(option);
            });
        }

        function selectCurrentPayPeriod() {
            if (!payPeriodsConfig || !payPeriodsConfig.payPeriods) return;
            
            // Check if we have a saved selection
            const savedSelection = localStorage.getItem('selectedPayPeriod');
            if (savedSelection) {
                const period = payPeriodsConfig.payPeriods.find(p => p.id === savedSelection);
                if (period) {
                    setPayPeriod(period);
                    return;
                }
            }
            
            // Auto-detect current pay period based on today's date
            const today = new Date().toISOString().split('T')[0];
            const currentPeriod = payPeriodsConfig.payPeriods.find(period => {
                return today >= period.startDate && today <= period.endDate;
            });
            
            if (currentPeriod) {
                setPayPeriod(currentPeriod);
            } else {
                // Find the next upcoming period
                const upcomingPeriod = payPeriodsConfig.payPeriods.find(period => {
                    return today < period.startDate;
                });
                
                if (upcomingPeriod) {
                    setPayPeriod(upcomingPeriod);
                }
            }
        }

        function setPayPeriod(period) {
            selectedPayPeriod = period;
            document.getElementById('payPeriodSelect').value = period.id;
            document.getElementById('periodStart').value = period.startDate;
            document.getElementById('periodEnd').value = period.endDate;
            
            updatePayPeriodInfo();
            updateDisplay();
            
            // Save selection
            localStorage.setItem('selectedPayPeriod', period.id);
        }

        function onPayPeriodChange() {
            const select = document.getElementById('payPeriodSelect');
            const periodId = select.value;
            
            if (!periodId) {
                selectedPayPeriod = null;
                document.getElementById('payPeriodInfo').style.display = 'none';
                return;
            }
            
            const period = payPeriodsConfig.payPeriods.find(p => p.id === periodId);
            if (period) {
                setPayPeriod(period);
            }
        }

        function onCustomDateChange() {
            // When user manually changes dates, clear pay period selection
            document.getElementById('payPeriodSelect').value = '';
            selectedPayPeriod = null;
            localStorage.removeItem('selectedPayPeriod');
            document.getElementById('payPeriodInfo').style.display = 'none';
            updateDisplay();
        }

        function updatePayPeriodInfo() {
            if (!selectedPayPeriod) {
                document.getElementById('payPeriodInfo').style.display = 'none';
                return;
            }
            
            const period = selectedPayPeriod;
            document.getElementById('payPeriodInfo').style.display = 'block';
            
            // Update period display
            document.getElementById('periodDisplay').textContent = 
                `${period.startDate} to ${period.endDate}`;
            document.getElementById('timesheetDue').textContent = period.timesheetDue || 'Not specified';
            document.getElementById('payDay').textContent = period.payDay || 'Not specified';
            
            // Calculate working days (excluding weekends and holidays)
            const workingDays = calculateWorkingDays(period.startDate, period.endDate);
            document.getElementById('workingDays').textContent = workingDays;
            
            // Calculate days remaining in period
            const today = new Date();
            const endDate = new Date(period.endDate);
            const daysRemaining = Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));
            document.getElementById('daysRemaining').textContent = daysRemaining;
        }

        function calculateWorkingDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let workingDays = 0;
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dayOfWeek = d.getDay();
                const dateStr = d.toISOString().split('T')[0];
                
                // Skip weekends
                if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                
                // Skip holidays
                if (companyHolidays.some(holiday => holiday.date === dateStr && holiday.observed)) continue;
                
                workingDays++;
            }
            
            return workingDays;
        }

        function enableManualDateSelection() {
            // Set default dates when config fails
            const today = new Date();
            const twoWeeksAgo = new Date(today);
            twoWeeksAgo.setDate(today.getDate() - 14);
            
            document.getElementById('periodStart').value = formatDate(twoWeeksAgo);
            document.getElementById('periodEnd').value = formatDate(today);
        }

        // Timer functionality
        function toggleTimer() {
            if (startTime) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            startTime = new Date();
            document.getElementById('timerButton').textContent = 'Stop';
            document.getElementById('timerButton').classList.remove('start');
            
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (!startTime) return;
            
            const endTime = new Date();
            const duration = (endTime - startTime) / (1000 * 60 * 60); // Hours
            
            const entry = {
                id: Date.now(),
                date: formatDate(new Date()),
                startTime: formatTime(startTime),
                endTime: formatTime(endTime),
                duration: parseFloat(duration.toFixed(2)),
                category: document.getElementById('categorySelect').value,
                project: document.getElementById('projectInput').value || 'No Project'
            };
            
            timeEntries.push(entry);
            saveData();
            
            // Reset timer
            startTime = null;
            clearInterval(timerInterval);
            document.getElementById('timerDisplay').textContent = '00:00:00';
            document.getElementById('timerButton').textContent = 'Start';
            document.getElementById('timerButton').classList.add('start');
            
            updateDisplay();
        }

        function updateTimer() {
            if (!startTime) return;
            
            const now = new Date();
            const elapsed = now - startTime;
            const hours = Math.floor(elapsed / (1000 * 60 * 60));
            const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
            
            document.getElementById('timerDisplay').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Data management
        function saveData() {
            localStorage.setItem('timeTrackerData', JSON.stringify(timeEntries));
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('timeTrackerData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Ensure we have a valid array
                    if (Array.isArray(parsed)) {
                        timeEntries = parsed;
                    } else {
                        console.warn('Invalid time entries data in localStorage, resetting to empty array');
                        timeEntries = [];
                        localStorage.removeItem('timeTrackerData');
                    }
                } else {
                    timeEntries = [];
                }
            } catch (error) {
                console.error('Error loading time entries data:', error);
                console.warn('Corrupted data detected, resetting to empty array');
                timeEntries = [];
                localStorage.removeItem('timeTrackerData');
            }
        }

        function saveSettings() {
            const settings = {
                employeeName: document.getElementById('employeeName').value,
                dailyTarget: document.getElementById('dailyTarget').value
            };
            localStorage.setItem('timeTrackerSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('timeTrackerSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('employeeName').value = settings.employeeName || '';
                document.getElementById('dailyTarget').value = settings.dailyTarget || 8;
            }
        }

        // Display updates
        function updateDisplay() {
            updateStats();
            updateDailyCounter();
            updateEntriesList();
            updatePayPeriodInfo();
        }

        function updateStats() {
            const filteredEntries = getFilteredEntries();
            const totalHours = filteredEntries.reduce((sum, entry) => sum + entry.duration, 0);
            const workDays = new Set(filteredEntries.map(entry => entry.date)).size;
            const avgDaily = workDays > 0 ? totalHours / workDays : 0;
            
            const startDate = document.getElementById('periodStart').value;
            const endDate = document.getElementById('periodEnd').value;
            let daysElapsed = 0;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                daysElapsed = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            }
            
            document.getElementById('totalHours').textContent = totalHours.toFixed(1);
            document.getElementById('workDays').textContent = workDays;
            document.getElementById('avgDaily').textContent = avgDaily.toFixed(1);
            document.getElementById('daysElapsed').textContent = daysElapsed;
        }

        function updateDailyCounter() {
            // Ensure timeEntries is always an array
            if (!Array.isArray(timeEntries)) {
                console.warn('timeEntries is not an array in updateDailyCounter, resetting');
                timeEntries = [];
                saveData();
            }
            
            const today = formatDate(new Date());
            const todayEntries = timeEntries.filter(entry => entry.date === today);
            const todayHours = todayEntries.reduce((sum, entry) => sum + entry.duration, 0);
            
            const target = parseFloat(document.getElementById('dailyTarget').value);
            const progressPercent = Math.min((todayHours / target) * 100, 100);
            
            document.getElementById('dailyCounter').textContent = `${todayHours.toFixed(1)} / ${target.toFixed(1)}h`;
            document.getElementById('progressFillSmall').style.width = `${progressPercent}%`;
        }

        function getFilteredEntries() {
            // Ensure timeEntries is always an array
            if (!Array.isArray(timeEntries)) {
                console.warn('timeEntries is not an array, resetting to empty array');
                timeEntries = [];
                saveData();
            }
            
            const startDate = document.getElementById('periodStart').value;
            const endDate = document.getElementById('periodEnd').value;
            
            if (!startDate || !endDate) return timeEntries;
            
            return timeEntries.filter(entry => {
                return entry.date >= startDate && entry.date <= endDate;
            });
        }

        function updateEntriesList() {
            const list = document.getElementById('entriesList');
            const filteredEntries = getFilteredEntries();
            
            if (filteredEntries.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #7f8c8d;">No time entries in selected period.</div>';
                return;
            }
            
            if (currentView === 'detailed') {
                renderDetailedView(list, filteredEntries);
            } else {
                renderDailySummaryView(list, filteredEntries);
            }
        }

        function renderDetailedView(container, entries) {
            let html = '<div class="entry" style="font-weight: bold; background: #f8f9fa; border-bottom: 2px solid #dee2e6;">';
            html += '<div>Date</div><div>Start</div><div>End</div><div>Project</div><div>Category</div><div>Hours</div><div>Actions</div>';
            html += '</div>';
            
            entries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(entry => {
                html += '<div class="entry">';
                html += `<div>${entry.date}</div>`;
                html += `<div>${entry.startTime}</div>`;
                html += `<div>${entry.endTime}</div>`;
                html += `<div>${entry.project}</div>`;
                html += `<div><span class="category-badge category-${entry.category}">${entry.category.toUpperCase()}</span></div>`;
                html += `<div>${entry.duration.toFixed(1)}h</div>`;
                html += `<div class="entry-actions">
                    <button class="action-button edit-button" onclick="editEntry(${entry.id})">Edit</button>
                    <button class="action-button delete-button" onclick="deleteEntry(${entry.id})">Del</button>
                </div>`;
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function renderDailySummaryView(container, entries) {
            const dailyGroups = {};
            
            entries.forEach(entry => {
                if (!dailyGroups[entry.date]) {
                    dailyGroups[entry.date] = [];
                }
                dailyGroups[entry.date].push(entry);
            });
            
            let html = '';
            Object.keys(dailyGroups).sort().reverse().forEach(date => {
                const dayEntries = dailyGroups[date];
                const totalHours = dayEntries.reduce((sum, entry) => sum + entry.duration, 0);
                
                html += `<div style="margin-bottom: 20px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">`;
                html += `<div style="background: #f8f9fa; padding: 15px; font-weight: bold; color: #2c3e50;">`;
                html += `📅 ${date} - ${totalHours.toFixed(1)} hours`;
                html += `</div>`;
                
                dayEntries.forEach(entry => {
                    html += `<div style="padding: 10px 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">`;
                    html += `<div>`;
                    html += `<span class="category-badge category-${entry.category}">${entry.category.toUpperCase()}</span> `;
                    html += `${entry.project} (${entry.startTime} - ${entry.endTime})`;
                    html += `</div>`;
                    html += `<div style="font-weight: bold;">${entry.duration.toFixed(1)}h</div>`;
                    html += `</div>`;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        // View controls
        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateEntriesList();
        }

        // Export functionality
        function exportToCSV() {
            const filteredEntries = getFilteredEntries();
            if (filteredEntries.length === 0) {
                alert('No data to export in selected period.');
                return;
            }
            
            const employeeName = document.getElementById('employeeName').value || 'Unknown Employee';
            const periodStart = document.getElementById('periodStart').value;
            const periodEnd = document.getElementById('periodEnd').value;
            
            let csv = 'Employee Name,Date,Category,Project,Start Time,End Time,Duration (Hours)\n';
            
            filteredEntries.forEach(entry => {
                const row = [
                    employeeName,
                    entry.date,
                    entry.category.toUpperCase(),
                    entry.project,
                    entry.startTime,
                    entry.endTime,
                    entry.duration
                ].map(field => `"${field}"`).join(',');
                
                csv += row + '\n';
            });
            
            const totalHours = filteredEntries.reduce((sum, entry) => sum + entry.duration, 0);
            const workDays = new Set(filteredEntries.map(entry => entry.date)).size;
            
            csv += '\n';
            csv += 'SUMMARY\n';
            csv += `Period,"${periodStart} to ${periodEnd}"\n`;
            csv += `Total Hours,${totalHours.toFixed(2)}\n`;
            csv += `Work Days,${workDays}\n`;
            csv += `Average Daily Hours,${workDays > 0 ? (totalHours / workDays).toFixed(2) : '0.00'}\n`;
            
            if (selectedPayPeriod) {
                csv += `Pay Period ID,"${selectedPayPeriod.id}"\n`;
                csv += `Timesheet Due,"${selectedPayPeriod.timesheetDue || 'Not specified'}"\n`;
                csv += `Pay Day,"${selectedPayPeriod.payDay || 'Not specified'}"\n`;
            }
            
            csv += `Export Date,"${formatDate(new Date())}"\n`;
            
            // Create filename with pay period context
            let filename = `${employeeName.replace(/\s+/g, '')}-TimeSheet`;
            if (selectedPayPeriod) {
                filename += `-${selectedPayPeriod.id}`;
            } else {
                filename += `-${periodStart}_to_${periodEnd}`;
            }
            filename += '.csv';
            
            downloadCSV(csv, filename);
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Import CSV functionality
        function importCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvContent = e.target.result;
                        const importedEntries = parseCSVContent(csvContent, file.name);
                        
                        if (importedEntries.length > 0) {
                            // Ask user if they want to append or replace
                            const append = confirm(
                                `Found ${importedEntries.length} time entries in the CSV.\n\n` +
                                `Click OK to ADD these entries to your existing data.\n` +
                                `Click Cancel to REPLACE all existing data with imported entries.`
                            );
                            
                            if (!append) {
                                timeEntries = [];
                            }
                            
                            // Add imported entries with new IDs to avoid conflicts
                            importedEntries.forEach(entry => {
                                entry.id = Date.now() + Math.random();
                                timeEntries.push(entry);
                            });
                            
                            saveData();
                            updateDisplay();
                            
                            alert(`Successfully imported ${importedEntries.length} time entries!`);
                        } else {
                            alert('No valid time entries found in the CSV file.');
                        }
                    } catch (error) {
                        console.error('Import error:', error);
                        alert('Error importing CSV file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function parseCSVContent(csvContent, fileName) {
            const lines = csvContent.split('\n');
            if (lines.length < 2) {
                throw new Error('CSV file appears to be empty or invalid');
            }
            
            // Parse header row
            const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
            console.log('CSV Headers:', headers);
            
            // Find column indices
            const columnMap = {
                employee: findColumnIndex(headers, ['employee name', 'employee', 'name']),
                date: findColumnIndex(headers, ['date']),
                category: findColumnIndex(headers, ['category', 'type']),
                project: findColumnIndex(headers, ['project']),
                startTime: findColumnIndex(headers, ['start time', 'start', 'start_time']),
                endTime: findColumnIndex(headers, ['end time', 'end', 'end_time']),
                duration: findColumnIndex(headers, ['duration', 'hours', 'duration (hours)'])
            };
            
            // Validate required columns
            if (columnMap.date === -1 || columnMap.startTime === -1 || columnMap.endTime === -1) {
                throw new Error('Missing required columns (Date, Start Time, End Time)');
            }
            
            const entries = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.toLowerCase().includes('summary') || line.toLowerCase().includes('period')) {
                    break; // Stop at summary section
                }
                
                const values = parseCSVLine(line);
                if (values.length < 3) continue;
                
                try {
                    const employeeName = cleanCSVValue(values[columnMap.employee]) || extractEmployeeFromFileName(fileName);
                    const category = cleanCSVValue(values[columnMap.category]) || 'work';
                    const project = cleanCSVValue(values[columnMap.project]) || 'No Project';
                    const startTime = cleanCSVValue(values[columnMap.startTime]);
                    const endTime = cleanCSVValue(values[columnMap.endTime]);
                    
                    let duration;
                    if (columnMap.duration !== -1 && values[columnMap.duration]) {
                        duration = parseFloat(cleanCSVValue(values[columnMap.duration]));
                    } else {
                        // Calculate duration from start/end times
                        duration = calculateDurationFromTimes(startTime, endTime);
                    }
                    
                    const entry = {
                        id: Date.now() + Math.random(), // Will be updated during import
                        date: cleanCSVValue(values[columnMap.date]),
                        startTime: startTime,
                        endTime: endTime,
                        duration: duration,
                        category: category.toLowerCase(),
                        project: project
                    };
                    
                    // Validate the entry
                    if (isValidEntry(entry)) {
                        entries.push(entry);
                    }
                } catch (entryError) {
                    console.warn(`Skipping invalid entry on line ${i + 1}:`, entryError.message);
                }
            }
            
            return entries;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function findColumnIndex(headers, possibleNames) {
            for (const name of possibleNames) {
                const index = headers.findIndex(h => h.includes(name));
                if (index !== -1) return index;
            }
            return -1;
        }

        function cleanCSVValue(value) {
            if (!value) return '';
            return value.toString().trim().replace(/^"/, '').replace(/"$/, '');
        }

        function extractEmployeeFromFileName(fileName) {
            const match = fileName.match(/^([^-]+)/);
            return match ? match[1].trim() : 'Unknown Employee';
        }

        function calculateDurationFromTimes(startTime, endTime) {
            try {
                const start = new Date(`2000-01-01T${startTime}:00`);
                const end = new Date(`2000-01-01T${endTime}:00`);
                
                if (end <= start) {
                    throw new Error('End time must be after start time');
                }
                
                return (end - start) / (1000 * 60 * 60); // Convert to hours
            } catch (error) {
                console.warn('Error calculating duration:', error);
                return 0;
            }
        }

        function isValidEntry(entry) {
            // Check required fields
            if (!entry.date || !entry.startTime || !entry.endTime) {
                return false;
            }
            
            // Check date format (YYYY-MM-DD)
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateRegex.test(entry.date)) {
                return false;
            }
            
            // Check time format (HH:MM)
            const timeRegex = /^\d{1,2}:\d{2}$/;
            if (!timeRegex.test(entry.startTime) || !timeRegex.test(entry.endTime)) {
                return false;
            }
            
            // Check that duration is positive
            if (entry.duration <= 0) {
                return false;
            }
            
            return true;
        }

        // Data management
        function clearAllData() {
            if (confirm('Are you sure you want to clear all time entries? This cannot be undone.')) {
                timeEntries = [];
                saveData();
                updateDisplay();
            }
        }

        function editEntry(id) {
            // Ensure timeEntries is an array before using find
            if (!Array.isArray(timeEntries)) {
                timeEntries = [];
                saveData();
                return;
            }
            
            const entry = timeEntries.find(e => e.id === id);
            if (!entry) return;
            
            const newProject = prompt('Edit project name:', entry.project);
            if (newProject !== null) {
                entry.project = newProject || 'No Project';
                saveData();
                updateDisplay();
            }
        }

        function deleteEntry(id) {
            if (confirm('Delete this time entry?')) {
                // Ensure timeEntries is an array before filtering
                if (!Array.isArray(timeEntries)) {
                    timeEntries = [];
                }
                timeEntries = timeEntries.filter(e => e.id !== id);
                saveData();
                updateDisplay();
            }
        }

        // Utility functions
        function formatDate(date) {
            const d = typeof date === 'string' ? new Date(date) : date;
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTime(date) {
            return date.toTimeString().split(' ')[0].substring(0, 5);
        }
    </script>
</body>
</html>